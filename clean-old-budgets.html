<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpar OrÃ§amentos Antigos</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #ff6b00;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 { color: #ff6b00; text-align: center; }
        .warning {
            background: #ff0000;
            color: #fff;
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-weight: bold;
            text-align: center;
        }
        .log {
            background: #000;
            padding: 1rem;
            border: 1px solid #ff6b00;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            margin: 1rem 0;
        }
        .log div {
            margin: 0.5rem 0;
            font-size: 13px;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning-text { color: #ffaa00; }
        .info { color: #00aaff; }
        button {
            background: #ff6b00;
            color: #000;
            border: none;
            padding: 1.2rem 2.5rem;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px;
            display: block;
            margin: 1rem auto;
            width: 100%;
            max-width: 400px;
        }
        button:hover { background: #ff5500; }
        button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>ğŸ—‘ï¸ DELETAR ORÃ‡AMENTOS ANTIGOS (DUPLICADOS)</h1>
    
    <div class="warning">
        âš ï¸ ATENÃ‡ÃƒO: Este script deleta APENAS os orÃ§amentos com valores em MILHÃ•ES<br>
        Os orÃ§amentos em BILHÃ•ES (corretos) serÃ£o PRESERVADOS<br>
        Execute ANTES de rodar update-budgets.html novamente
    </div>

    <button id="btnClean" onclick="cleanOldBudgets()">ğŸ—‘ï¸ DELETAR ORÃ‡AMENTOS ANTIGOS</button>
    
    <div class="log" id="log"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBLmX8UGHzmnMkLy16t3SwojA6u67lyvVA",
          authDomain: "governo-chocotone.firebaseapp.com",
          projectId: "governo-chocotone",
          storageBucket: "governo-chocotone.firebasestorage.app",
          messagingSenderId: "829728497507",
          appId: "1:829728497507:web:5689c0ad79c42dbe583d56"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function log(message, type = 'success') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.cleanOldBudgets = async function() {
            const btn = document.getElementById('btnClean');
            btn.disabled = true;
            
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ—‘ï¸ INICIANDO LIMPEZA DE ORÃ‡AMENTOS ANTIGOS', 'warning-text');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('', 'success');

            // Login como Presidenta
            log('ğŸ” Fazendo login como Presidenta...', 'warning-text');
            try {
                await signInWithEmailAndPassword(auth, 'chocotone@gov.br', 'GovChoco2025!');
                log('âœ… Login realizado!', 'success');
                log('', 'success');
            } catch (error) {
                log(`âŒ Erro ao fazer login: ${error.message}`, 'error');
                btn.textContent = 'âŒ ERRO';
                btn.style.background = '#ff0000';
                return;
            }

            log('ğŸ“¥ Buscando orÃ§amentos duplicados...', 'info');
            log('', 'success');

            let deleted = 0;
            let preserved = 0;

            try {
                const budgetsSnapshot = await getDocs(collection(db, 'budgets'));
                
                for (const docSnapshot of budgetsSnapshot.docs) {
                    if (docSnapshot.id === '_init') continue;

                    const data = docSnapshot.data();
                    const totalBudget = data.totalBudget || 0;

                    // Deletar se for valor em MILHÃ•ES (< 100 milhÃµes)
                    if (totalBudget < 100000000) {  // Menor que 100 milhÃµes
                        log(`ğŸ—‘ï¸ Deletando: ${data.ministry} (R$ ${(totalBudget / 1000000).toFixed(1)}M) - ANTIGO`, 'warning-text');
                        await deleteDoc(doc(db, 'budgets', docSnapshot.id));
                        deleted++;
                    } else {
                        log(`âœ… Preservado: ${data.ministry} (R$ ${(totalBudget / 1000000000).toFixed(1)}B) - CORRETO`, 'success');
                        preserved++;
                    }
                }

                log('', 'success');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
                log('ğŸ‰ LIMPEZA CONCLUÃDA!', 'success');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
                log('', 'success');
                log(`ğŸ“Š Deletados: ${deleted} orÃ§amentos antigos`, 'warning-text');
                log(`âœ… Preservados: ${preserved} orÃ§amentos corretos`, 'success');
                log('', 'success');
                log('â¡ï¸ Volte ao dashboard e atualize (F5)', 'info');

                btn.textContent = 'âœ… LIMPEZA CONCLUÃDA';
                btn.style.background = '#00aa00';

            } catch (error) {
                log(`âŒ ERRO: ${error.message}`, 'error');
                btn.textContent = 'âŒ ERRO';
                btn.style.background = '#ff0000';
            }
        };

        log('âœ… Firebase inicializado', 'success');
        log('âš ï¸ Clique para deletar orÃ§amentos duplicados', 'warning-text');
    </script>
</body>
</html>
