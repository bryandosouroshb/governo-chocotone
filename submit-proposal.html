<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submeter Proposta - Sistema Or√ßament√°rio</title>
    <link rel="icon" type="image/gif" href="https://www.habbo.com.br/habbo-imaging/badge/b11044s02014t21134s04064s3911450c22ff6b1fd8b46488a58028697ae6a.gif">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #ffd700;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 40px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #333;
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-badge {
            width: 50px;
            height: 50px;
            background: url('https://www.habbo.com.br/habbo-imaging/badge/b11044s02014t21134s04064s3911450c22ff6b1fd8b46488a58028697ae6a.gif') no-repeat center;
            background-size: contain;
        }

        .logo-text h1 {
            font-size: 1.3rem;
            color: var(--primary-color);
            font-weight: 800;
        }

        .btn-back {
            background: var(--bg-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            text-decoration: none;
            display: inline-block;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Form Card */
        .form-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: var(--card-shadow);
            animation: fadeInUp 0.5s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 3px solid #f0f0f0;
        }

        .form-title {
            font-size: 2rem;
            color: var(--primary-color);
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .form-subtitle {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }

        /* Budget Info */
        .budget-info {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border-left: 5px solid var(--success-color);
        }

        .budget-info.warning {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left-color: var(--warning-color);
        }

        .budget-info.danger {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left-color: var(--danger-color);
        }

        .budget-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .budget-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-color);
        }

        /* Form Group */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-label .required {
            color: var(--danger-color);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            font-weight: 500;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
        }

        .form-select {
            cursor: pointer;
            background: white;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input[type="number"] {
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Helper Text */
        .helper-text {
            font-size: 0.85rem;
            color: #999;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .error-text {
            font-size: 0.85rem;
            color: var(--danger-color);
            margin-top: 0.5rem;
            font-weight: 600;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            border: 2px solid #e0e0e0;
            transition: var(--transition);
        }

        .checkbox-group:hover {
            border-color: var(--primary-color);
        }

        .checkbox-group input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            margin-top: 2px;
        }

        .checkbox-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: #333;
            line-height: 1.5;
        }

        .checkbox-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 700;
            border-bottom: 2px solid var(--accent-color);
            transition: var(--transition);
        }

        .checkbox-link:hover {
            color: var(--secondary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Buttons */
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 1.25rem 2rem;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            animation: slideUp 0.3s ease;
            text-align: center;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 2rem;
            color: var(--primary-color);
            font-weight: 800;
            margin-bottom: 1rem;
        }

        .modal-message {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
        }

        /* Constitutional Analysis */
        .constitutional-box {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border-left: 5px solid var(--warning-color);
        }

        .constitutional-box h3 {
            color: var(--primary-color);
            font-size: 1.2rem;
            font-weight: 800;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .constitutional-box p {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .btn-analyze {
            background: var(--warning-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            .form-card {
                padding: 2rem 1.5rem;
            }

            .form-title {
                font-size: 1.5rem;
            }

            .form-actions {
                flex-direction: column;
            }

            .modal-content {
                padding: 2rem 1.5rem;
                max-width: 95vw;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .btn-back {
                width: 100%;
                text-align: center;
            }

            header h1 {
                font-size: 1.3rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            input, select, textarea {
                font-size: 16px; /* Previne zoom no iOS */
            }

            .btn {
                padding: 1rem;
                font-size: 1rem;
                touch-action: manipulation;
            }
        }

        @media (max-width: 480px) {
            .form-card {
                padding: 1.5rem 1rem;
            }

            header {
                padding: 1rem;
            }

            .logo-badge {
                width: 35px;
                height: 35px;
            }

            header h1 {
                font-size: 1.1rem;
            }
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid rgba(26, 35, 126, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-badge"></div>
                <div class="logo-text">
                    <h1>üìù Submeter Proposta Or√ßament√°ria</h1>
                </div>
            </div>
            <a href="dashboard.html" class="btn-back">‚Üê Voltar ao Dashboard</a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <div class="form-card">
            <div class="form-header">
                <div class="form-title">Nova Proposta Or√ßament√°ria</div>
                <div class="form-subtitle">Preencha todos os campos obrigat√≥rios e valide a constitucionalidade</div>
            </div>

            <!-- Budget Info -->
            <div class="budget-info" id="budgetInfo">
                <div class="budget-label">Or√ßamento Dispon√≠vel - <span id="ministryName">Seu Minist√©rio</span></div>
                <div class="budget-value" id="availableBudget">R$ 0,00</div>
                <div class="helper-text" style="margin-top: 0.5rem;">
                    Gasto at√© agora: <strong id="spentBudget">R$ 0,00</strong> | 
                    Total alocado: <strong id="totalBudget">R$ 0,00</strong>
                </div>
            </div>

            <!-- Constitutional Analysis Box -->
            <div class="constitutional-box">
                <h3>‚öñÔ∏è An√°lise de Constitucionalidade</h3>
                <p>
                    Antes de submeter sua proposta, √© <strong>obrigat√≥rio</strong> verificar a constitucionalidade 
                    do documento utilizando nossa ferramenta de an√°lise baseada na Constitui√ß√£o Federal de RPG Habbo.
                </p>
                <button type="button" class="btn-analyze" onclick="openConstitutionalAnalysis()">
                    üîç Analisar Constitucionalidade (NotebookLM)
                </button>
            </div>

            <!-- Form -->
            <form id="proposalForm">
                <!-- Nome (s√≥ aparece para Presidenta/Vice) -->
                <div class="form-group" id="requestorNameGroup" style="display: none;">
                    <label class="form-label">
                        Nome do Solicitante <span class="required">*</span>
                    </label>
                    <select class="form-select" id="requestorName">
                        <option value="">Selecione...</option>
                        <optgroup label="Presid√™ncia">
                            <option value="Chocotone">Chocotone (Presidenta)</option>
                            <option value="Bryan dos Ouros">Bryan dos Ouros (Vice-Presidente)</option>
                        </optgroup>
                        <optgroup label="Ministros">
                            <option value="-Furia-">-Furia- (Economia e Trabalho)</option>
                            <option value="joaobatistagc">joaobatistagc (Sa√∫de)</option>
                            <option value="Stroch">Stroch (Educa√ß√£o, Ci√™ncia e Tecnologia)</option>
                            <option value="Nyxalis">Nyxalis (Cidadania)</option>
                            <option value="MalopRRN">MalopRRN (Defesa)</option>
                            <option value="guguinhoHop">guguinhoHop (Justi√ßa e Seguran√ßa)</option>
                            <option value="Dj.Bigoreia">Dj.Bigoreia (Infraestrutura)</option>
                            <option value="Fabio-Blunt-UK">Fabio-Blunt-UK (Agricultura)</option>
                            <option value="Brenda.M">Brenda.M (Cultura e Esporte)</option>
                            <option value="Stallley">Stallley (AGU)</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Cargo -->
                <div class="form-group">
                    <label class="form-label">
                        Cargo / Minist√©rio <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="position" readonly required>
                    <div class="helper-text">Preenchido automaticamente com base no nome selecionado</div>
                </div>

                <!-- Tipo de Documento -->
                <div class="form-group">
                    <label class="form-label">
                        Tipo de Documento <span class="required">*</span>
                    </label>
                    <select class="form-select" id="documentType" required>
                        <option value="">Selecione...</option>
                        <option value="Of√≠cio">Of√≠cio</option>
                        <option value="Portaria">Portaria</option>
                        <option value="Decreto">Decreto Presidencial</option>
                        <option value="Medida Provis√≥ria">Medida Provis√≥ria</option>
                    </select>
                    <div class="helper-text">Decretos e MPs s√≥ podem ser emitidos pela Presid√™ncia</div>
                </div>

                <!-- Custo Estimado -->
                <div class="form-group">
                    <label class="form-label">
                        Custo Estimado (R$) <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="estimatedCost" placeholder="R$ 0,00" required>
                    <input type="hidden" id="estimatedCostValue">
                    <div class="helper-text" id="costHelper">Digite o valor (ser√° formatado automaticamente em reais)</div>
                </div>

                <!-- Ementa -->
                <div class="form-group">
                    <label class="form-label">
                        Ementa <span class="required">*</span>
                    </label>
                    <input type="text" class="form-input" id="summary" maxlength="200" required>
                    <div class="helper-text">Breve resumo do documento (m√°x. 200 caracteres)</div>
                </div>

                <!-- Corpo -->
                <div class="form-group">
                    <label class="form-label">
                        Corpo do Documento <span class="required">*</span>
                    </label>
                    <textarea class="form-textarea" id="body" rows="8" required></textarea>
                    <div class="helper-text">Conte√∫do completo do documento legal</div>
                </div>

                <!-- Justificativa -->
                <div class="form-group">
                    <label class="form-label">
                        Justificativa <span class="required">*</span>
                    </label>
                    <textarea class="form-textarea" id="justification" rows="6" required></textarea>
                    <div class="helper-text">Explique a necessidade e impacto da proposta</div>
                </div>

                <!-- Checkbox de Constitucionalidade -->
                <div class="checkbox-group">
                    <input type="checkbox" id="constitutionalCheck" required>
                    <label class="checkbox-label" for="constitutionalCheck">
                        Declaro que analisei a constitucionalidade deste documento atrav√©s do 
                        <a href="https://notebooklm.google.com/notebook/68793eb3-1c33-41f5-a0b8-c2d54e7c4cb9" 
                           target="_blank" 
                           class="checkbox-link">NotebookLM</a> 
                        e confirmo que est√° em conformidade com a Constitui√ß√£o Federal de RPG Habbo. <span class="required">*</span>
                    </label>
                </div>

                <!-- Loading -->
                <div class="loading" id="loadingSubmit">
                    <div class="spinner"></div>
                    <div>Enviando proposta...</div>
                </div>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        üîÑ Limpar Formul√°rio
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnSubmit">
                        ‚úÖ Submeter Proposta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-icon">‚úÖ</div>
            <div class="modal-title">Proposta Enviada!</div>
            <div class="modal-message">
                Sua proposta foi enviada com sucesso e aguarda aprova√ß√£o da Presid√™ncia.
                Voc√™ ser√° notificado sobre o status.
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="window.location.href='dashboard.html'">
                    Voltar ao Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal" id="errorModal">
        <div class="modal-content">
            <div class="modal-icon">‚ùå</div>
            <div class="modal-title">Erro ao Enviar</div>
            <div class="modal-message" id="errorMessage">
                Ocorreu um erro ao enviar sua proposta. Tente novamente.
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('errorModal')">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBLmX8UGHzmnMkLy16t3SwojA6u67lyvVA",
          authDomain: "governo-chocotone.firebaseapp.com",
          projectId: "governo-chocotone",
          storageBucket: "governo-chocotone.firebasestorage.app",
          messagingSenderId: "829728497507",
          appId: "1:829728497507:web:5689c0ad79c42dbe583d56"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Configura√ß√µes
        const CONFIG = {
            NOTEBOOKLM_URL: 'https://notebooklm.google.com/notebook/68793eb3-1c33-41f5-a0b8-c2d54e7c4cb9'
        };

        // Mapeamento de nomes para cargos e minist√©rios
        const GOVERNMENT_MEMBERS = {
            'Chocotone': { position: 'Presidenta da Rep√∫blica', ministry: 'Gabinete da Presid√™ncia', budget: 150000000000 },
            'Bryan dos Ouros': { position: 'Vice-Presidente da Rep√∫blica + Ministro-Chefe da Casa Civil', ministry: 'Casa Civil', budget: 15000000000 },
            '-Furia-': { position: 'Ministro da Economia e Trabalho', ministry: 'Economia e Trabalho', budget: 250000000000 },
            'joaobatistagc': { position: 'Ministra da Sa√∫de', ministry: 'Sa√∫de', budget: 200000000000 },
            'Stroch': { position: 'Ministro da Educa√ß√£o, Ci√™ncia e Tecnologia', ministry: 'Educa√ß√£o, Ci√™ncia e Tecnologia', budget: 260000000000 },
            'Nyxalis': { position: 'Ministra da Cidadania, Desenvolvimento Social, Direitos Humanos e Povos Origin√°rios', ministry: 'Cidadania, Desenvolvimento Social, Direitos Humanos e Povos Origin√°rios', budget: 250000000000 },
            'MalopRRN': { position: 'Ministro da Defesa', ministry: 'Defesa', budget: 150000000000 },
            'guguinhoHop': { position: 'Ministro da Justi√ßa e Seguran√ßa P√∫blica', ministry: 'Justi√ßa e Seguran√ßa P√∫blica', budget: 120000000000 },
            'Dj.Bigoreia': { position: 'Ministro da Infraestrutura', ministry: 'Infraestrutura', budget: 300000000000 },
            'Fabio-Blunt-UK': { position: 'Ministro da Agricultura, Meio Ambiente, Turismo e Desenvolvimento Rural', ministry: 'Agricultura, Meio Ambiente, Turismo e Desenvolvimento Rural', budget: 130000000000 },
            'Brenda.M': { position: 'Ministra da Cultura e Esporte', ministry: 'Cultura e Esporte', budget: 45000000000 },
            'Stallley': { position: 'Advogado-Geral da Uni√£o', ministry: 'Advocacia-Geral da Uni√£o', budget: 30000000000 }
        };

        // Estado
        let currentUser = null;
        let currentBudget = 0;
        let spentBudget = 0;
        let firebaseUser = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            setupEventListeners();
        });

        function checkAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    firebaseUser = user;
                    loadUserData();
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        async function loadUserData() {
            const storedUser = localStorage.getItem('govUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                
                // Se for Presidenta ou Vice, mostra dropdown de nomes
                if (currentUser.role === 'Presidenta' || currentUser.role === 'Vice-Presidente') {
                    document.getElementById('requestorNameGroup').style.display = 'block';
                    document.getElementById('requestorName').required = true;
                } else {
                    // Para ministros, preenche automaticamente com seu nome
                    document.getElementById('requestorName').value = currentUser.name;
                    updatePosition({ target: { value: currentUser.name } });
                }

                // Carregar or√ßamento do Firestore
                await loadBudgetFromFirestore();
                
                displayUserInfo();
            } else {
                window.location.href = 'index.html';
            }
        }

        async function loadBudgetFromFirestore() {
            try {
                // Para Presidenta/Vice, pegar todos os or√ßamentos
                if (currentUser.role === 'Presidenta' || currentUser.role === 'Vice-Presidente') {
                    // Ser√° atualizado quando selecionar um nome no dropdown
                    return;
                }

                // Para ministros, buscar or√ßamento espec√≠fico do minist√©rio
                const ministryName = currentUser.ministries;
                const budgetDoc = await getDoc(doc(db, 'budgets', ministryName));
                
                if (budgetDoc.exists()) {
                    const budgetData = budgetDoc.data();
                    currentBudget = budgetData.totalBudget;
                    spentBudget = budgetData.spent || 0;
                } else {
                    console.error('Or√ßamento n√£o encontrado para:', ministryName);
                }
            } catch (error) {
                console.error('Erro ao carregar or√ßamento:', error);
            }
        }

        function setupEventListeners() {
            document.getElementById('requestorName').addEventListener('change', updatePosition);
            document.getElementById('documentType').addEventListener('change', validateDocumentType);
            document.getElementById('estimatedCost').addEventListener('input', formatCostInput);
            document.getElementById('proposalForm').addEventListener('submit', handleSubmit);
        }

        function displayUserInfo() {
            if (!currentUser) return;
            
            const member = GOVERNMENT_MEMBERS[currentUser.name];
            if (member) {
                updateBudgetInfo();
            }
        }

        function updatePosition(e) {
            const name = e.target.value;
            const positionInput = document.getElementById('position');
            
            if (name && GOVERNMENT_MEMBERS[name]) {
                const member = GOVERNMENT_MEMBERS[name];
                positionInput.value = member.position;
                currentBudget = member.budget;
                updateBudgetInfo();
            } else {
                positionInput.value = '';
            }
        }

        function updateBudgetInfo() {
            if (!currentUser) return;

            const member = GOVERNMENT_MEMBERS[currentUser.name];
            if (!member) return;

            currentBudget = member.budget;
            const available = currentBudget - spentBudget;

            document.getElementById('ministryName').textContent = member.ministry;
            document.getElementById('availableBudget').textContent = formatCurrency(available);
            document.getElementById('spentBudget').textContent = formatCurrency(spentBudget);
            document.getElementById('totalBudget').textContent = formatCurrency(currentBudget);

            const budgetInfo = document.getElementById('budgetInfo');
            const percentUsed = (spentBudget / currentBudget) * 100;

            budgetInfo.classList.remove('warning', 'danger');
            if (percentUsed >= 90) {
                budgetInfo.classList.add('danger');
            } else if (percentUsed >= 70) {
                budgetInfo.classList.add('warning');
            }
        }

        function validateDocumentType(e) {
            const type = e.target.value;
            const name = document.getElementById('requestorName').value;
            
            if ((type === 'Decreto' || type === 'Medida Provis√≥ria') && 
                name !== 'Chocotone' && name !== 'Bryan dos Ouros') {
                alert('‚ö†Ô∏è Apenas a Presidenta e Vice-Presidente podem emitir Decretos e Medidas Provis√≥rias!');
                e.target.value = '';
            }
        }

        function formatCostInput(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero
            
            if (value === '') {
                e.target.value = '';
                document.getElementById('estimatedCostValue').value = '0';
                return;
            }
            
            // Converte para n√∫mero e formata
            const numValue = parseInt(value) / 100;
            document.getElementById('estimatedCostValue').value = numValue;
            
            // Formata para exibi√ß√£o
            e.target.value = 'R$ ' + numValue.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            // Valida or√ßamento
            validateCost(numValue);
        }

        function validateCost(cost) {
            const available = currentBudget - spentBudget;
            const costHelper = document.getElementById('costHelper');

            if (cost > available) {
                costHelper.textContent = `‚ö†Ô∏è ATEN√á√ÉO: Valor excede o or√ßamento dispon√≠vel (${formatCurrency(available)})`;
                costHelper.style.color = '#f44336';
                costHelper.style.fontWeight = '700';
            } else if (cost > available * 0.5) {
                costHelper.textContent = `‚ö†Ô∏è Valor representa mais de 50% do or√ßamento dispon√≠vel`;
                costHelper.style.color = '#ff9800';
                costHelper.style.fontWeight = '600';
            } else {
                costHelper.textContent = `‚úì Valor dentro do or√ßamento dispon√≠vel`;
                costHelper.style.color = '#4caf50';
                costHelper.style.fontWeight = '600';
            }
        }

        function openConstitutionalAnalysis() {
            window.open(CONFIG.NOTEBOOKLM_URL, '_blank', 'width=1200,height=800');
        }

        async function handleSubmit(e) {
            e.preventDefault();

            // Para ministros, usa o nome do usu√°rio logado. Para Presidenta/Vice, usa o selecionado
            const requestorName = (currentUser.role === 'Presidenta' || currentUser.role === 'Vice-Presidente') 
                ? document.getElementById('requestorName').value 
                : currentUser.name;

            const formData = {
                requestorName: requestorName,
                position: document.getElementById('position').value,
                documentType: document.getElementById('documentType').value,
                estimatedCost: parseFloat(document.getElementById('estimatedCostValue').value) || 0,
                summary: document.getElementById('summary').value,
                body: document.getElementById('body').value,
                justification: document.getElementById('justification').value,
                constitutionalCheck: document.getElementById('constitutionalCheck').checked,
                submittedAt: new Date().toISOString(),
                status: 'pending'
            };

            // Valida√ß√µes
            if (!formData.constitutionalCheck) {
                showError('Voc√™ deve confirmar a an√°lise de constitucionalidade!');
                return;
            }

            const available = currentBudget - spentBudget;
            if (formData.estimatedCost > available) {
                showError(`O custo estimado (${formatCurrency(formData.estimatedCost)}) excede o or√ßamento dispon√≠vel (${formatCurrency(available)})!`);
                return;
            }

            // Mostrar loading
            document.getElementById('loadingSubmit').classList.add('active');
            document.getElementById('btnSubmit').disabled = true;

            try {
                // Salvar proposta no Firestore
                const proposalData = {
                    ...formData,
                    requestorUid: firebaseUser.uid,
                    requestorEmail: currentUser.email,
                    ministry: document.getElementById('position').value.includes('Ministro') 
                        ? GOVERNMENT_MEMBERS[requestorName].ministry 
                        : 'Gabinete da Presid√™ncia',
                    createdAt: serverTimestamp(),
                    publicationStatus: 'pending_approval',
                    feedback: null,
                    approvedAt: null,
                    publishedAt: null,
                    inForceAt: null
                };

                const proposalRef = await addDoc(collection(db, 'proposals'), proposalData);
                console.log('Proposta criada:', proposalRef.id);

                // Criar notifica√ß√£o para Presidenta e Vice
                const notificationData = {
                    type: 'proposal_submitted',
                    title: 'üìù Nova Proposta Recebida',
                    message: `${formData.requestorName} submeteu: ${formData.documentType}`,
                    senderName: formData.requestorName,
                    senderUid: firebaseUser.uid,
                    senderRole: currentUser.role,
                    proposalId: proposalRef.id,
                    documentType: formData.documentType,
                    summary: formData.summary,
                    ministry: proposalData.ministry,
                    estimatedCost: formData.estimatedCost,
                    status: 'submitted',
                    targetUsers: Array.from(new Set([
                        'all',
                        'Presidenta',
                        'Vice-Presidente',
                        'role:Presidenta',
                        'role:Vice-Presidente',
                        'Chocotone',
                        'Bryan dos Ouros',
                        'name:Chocotone',
                        'name:Bryan dos Ouros'
                    ])),
                    readBy: [],
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, 'notifications'), notificationData);
                console.log('Notifica√ß√£o criada para Presidenta/Vice');

                // Mostrar sucesso
                document.getElementById('loadingSubmit').classList.remove('active');
                document.getElementById('successModal').classList.add('active');

            } catch (error) {
                console.error('Erro ao enviar proposta:', error);
                document.getElementById('loadingSubmit').classList.remove('active');
                document.getElementById('btnSubmit').disabled = false;
                showError('Erro ao enviar proposta. Tente novamente.');
            }
        }

        function resetForm() {
            if (confirm('Deseja realmente limpar todos os campos?')) {
                document.getElementById('proposalForm').reset();
                document.getElementById('position').value = '';
                document.getElementById('costHelper').textContent = 'Digite o valor em reais (ex: 1000000.00)';
                document.getElementById('costHelper').style.color = '#999';
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Expor fun√ß√µes para uso global
        window.openConstitutionalAnalysis = openConstitutionalAnalysis;
        window.resetForm = resetForm;
        window.closeModal = closeModal;

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(value);
        }
    </script>
</body>
</html>
