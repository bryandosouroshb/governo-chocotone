<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Or√ßament√°ria - Governo Federal Chocotone</title>
    <link rel="icon" type="image/gif" href="https://www.habbo.com.br/habbo-imaging/badge/b11044s02014t21134s04064s3911450c22ff6b1fd8b46488a58028697ae6a.gif">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #ffd700;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 40px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
            margin-top: 20px;
            font-weight: 600;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-badge {
            width: 60px;
            height: 60px;
            background: url('https://www.habbo.com.br/habbo-imaging/badge/b11044s02014t21134s04064s3911450c22ff6b1fd8b46488a58028697ae6a.gif') no-repeat center;
            background-size: contain;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .logo-text h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 800;
        }

        .logo-text p {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-badge {
            background: var(--bg-gradient);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-habbo-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            background: rgba(255, 255, 255, 0.1);
            object-fit: cover;
            image-rendering: pixelated;
        }

        .user-role {
            background: var(--accent-color);
            color: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .btn-logout {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
        }

        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .btn-notif {
            background: white;
            color: #1a237e;
            border: 2px solid #e0e0e0;
            padding: 0.75rem 1rem;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-notif:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            animation: fadeInUp 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--bg-gradient);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .card-icon {
            font-size: 2rem;
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            word-break: break-word;
            line-height: 1.2;
            overflow-wrap: break-word;
        }

        .card-subtitle {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
            word-wrap: break-word;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--bg-gradient);
            border-radius: 10px;
            transition: width 1s ease;
        }

        /* Big Budget Display */
        .budget-showcase {
            background: white;
            border-radius: 30px;
            padding: 3rem;
            box-shadow: var(--card-shadow);
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.5s ease 0.2s backwards;
        }

        .budget-showcase::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            to { transform: rotate(360deg); }
        }

        .budget-label {
            font-size: 1.2rem;
            color: #666;
            font-weight: 600;
            margin-bottom: 1rem;
            position: relative;
        }

        .budget-amount {
            font-size: 4rem;
            font-weight: 900;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            position: relative;
            word-break: break-word;
            line-height: 1.1;
        }

        .budget-date {
            font-size: 1rem;
            color: #999;
            font-weight: 500;
            position: relative;
            word-wrap: break-word;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 200px;
            padding: 1.5rem 2rem;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-admin {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: var(--primary-color);
        }

        .btn-ia {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Ministry Budget Table */
        .ministry-table {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            overflow-x: auto;
            animation: fadeInUp 0.5s ease 0.4s backwards;
        }

        .ministry-table h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-weight: 800;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead tr {
            background: var(--bg-gradient);
            color: white;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 250px;
        }

        th {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: var(--transition);
        }

        tbody tr:hover {
            background: #f8f9ff;
            transform: scale(1.01);
        }

        td {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-ok {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-warning {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-danger {
            background: #ffebee;
            color: #c62828;
        }

        /* Indicators Section */
        .indicators-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-top: 2rem;
            animation: fadeInUp 0.5s ease 0.6s backwards;
        }

        .indicators-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .indicators-header h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 800;
        }

        .btn-update-indicators {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Montserrat', sans-serif;
        }

        .btn-update-indicators:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-update-indicators:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .indicator-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .indicator-status {
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
        }

        .indicator-status.success {
            color: #2e7d32;
        }

        .indicator-status.error {
            color: #c62828;
        }

        .indicator-status.info {
            color: #5c6bc0;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .indicator-card {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 15px;
            border-left: 4px solid;
            transition: var(--transition);
        }

        .indicator-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .indicator-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .indicator-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary-color);
            word-break: break-word;
            line-height: 1.2;
        }

        .indicator-change {
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
            white-space: nowrap;
        }

        .indicator-change.positive {
            color: var(--success-color);
        }

        .indicator-change.negative {
            color: var(--danger-color);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            position: relative;
        }

        .modal-content.accent-success::before,
        .modal-content.accent-warning::before,
        .modal-content.accent-error::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            border-radius: 20px 20px 0 0;
        }

        .modal-content.accent-success::before {
            background: linear-gradient(90deg, #4caf50, #81c784);
        }

        .modal-content.accent-warning::before {
            background: linear-gradient(90deg, #ff9800, #ffb74d);
        }

        .modal-content.accent-error::before {
            background: linear-gradient(90deg, #f44336, #e57373);
        }

        .adjustment-modal-content {
            max-width: 760px;
        }

        .adjustment-feedback {
            background: rgba(255, 152, 0, 0.18);
            border-left: 4px solid #ff9800;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            color: #8b5a13;
            font-weight: 600;
            margin-bottom: 1.5rem;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .adjustment-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .adjustment-meta-item {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 0.85rem 1rem;
            border: 1px solid #e0e7ff;
        }

        .adjustment-meta-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #5c6bc0;
            font-weight: 700;
            margin-bottom: 0.35rem;
        }

        .adjustment-meta-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1a237e;
        }

        .adjustment-form-group {
            margin-bottom: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .adjustment-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .adjustment-input,
        .adjustment-textarea {
            width: 100%;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 0.85rem 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .adjustment-input:focus,
        .adjustment-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .adjustment-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        .adjustment-helper {
            font-size: 0.75rem;
            color: #666;
        }

        .adjustment-error {
            background: rgba(244, 67, 54, 0.12);
            border-left: 4px solid #f44336;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            color: #c62828;
            font-weight: 600;
            margin-bottom: 1rem;
            display: none;
        }

        .adjustment-actions .btn-modal {
            flex: 1;
        }

        /* Legal Assistant Modal */
        .legal-assistant-content {
            max-width: 1100px;
            padding: 2.5rem;
        }

        .legal-assistant-body {
            padding: 0;
        }

        .legal-assistant-grid {
            display: grid;
            grid-template-columns: minmax(320px, 0.55fr) minmax(360px, 0.45fr);
            gap: 2rem;
            align-items: flex-start;
        }

        .legal-assistant-panel {
            background: #f8f9ff;
            border-radius: 18px;
            padding: 1.75rem;
            border: 1px solid #dfe4ff;
            box-shadow: 0 18px 35px rgba(26, 35, 126, 0.08);
        }

        .legal-assistant-panel--result {
            background: white;
            display: flex;
            flex-direction: column;
        }

        .legal-assistant-field {
            margin-bottom: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .legal-assistant-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legal-assistant-input,
        .legal-assistant-select,
        .legal-assistant-textarea {
            width: 100%;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 0.85rem 1rem;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background: white;
        }

        .legal-assistant-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.6;
        }

        .legal-assistant-input:focus,
        .legal-assistant-select:focus,
        .legal-assistant-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.18);
        }

        .legal-assistant-helper {
            font-size: 0.75rem;
            color: #666;
        }

        .legal-assistant-signers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem;
            max-height: 260px;
            overflow-y: auto;
            padding: 0.75rem;
            border: 1px solid #e0e7ff;
            border-radius: 14px;
            background: rgba(236, 239, 253, 0.65);
        }

        .legal-assistant-signer-group-title {
            grid-column: 1 / -1;
            font-size: 0.8rem;
            font-weight: 700;
            color: #5c6bc0;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-top: 0.5rem;
        }

        .legal-assistant-signer {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            padding: 0.85rem 1rem;
            border-radius: 12px;
            border: 1px solid transparent;
            background: white;
            box-shadow: 0 8px 18px rgba(26, 35, 126, 0.08);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }

        .legal-assistant-signer input {
            margin-top: 0.2rem;
            cursor: pointer;
        }

        .legal-assistant-signer.active {
            border-color: rgba(102, 126, 234, 0.8);
            box-shadow: 0 12px 26px rgba(102, 126, 234, 0.18);
            transform: translateY(-2px);
        }

        .legal-assistant-signer-info {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .legal-assistant-signer-name {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.95rem;
        }

        .legal-assistant-signer-role,
        .legal-assistant-signer-habbo {
            font-size: 0.78rem;
            color: #666;
        }

        .legal-assistant-primary-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .legal-assistant-primary-actions .btn {
            flex: 1;
            min-width: 180px;
        }

        .legal-assistant-status {
            min-height: 1.2rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1a237e;
            margin-bottom: 1rem;
        }

        .legal-assistant-status.success {
            color: #2e7d32;
        }

        .legal-assistant-status.error {
            color: #c62828;
        }

        .legal-assistant-result {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .legal-assistant-placeholder {
            background: rgba(236, 239, 253, 0.65);
            border: 1px dashed #b0b7ff;
            border-radius: 16px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            color: #5c6bc0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .legal-assistant-placeholder strong {
            font-size: 1rem;
            color: var(--primary-color);
        }

        .legal-assistant-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem 1rem;
            text-align: center;
            color: var(--primary-color);
        }

        .legal-assistant-spinner {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 4px solid rgba(102, 126, 234, 0.25);
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        .legal-assistant-section {
            background: #f8f9ff;
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            border: 1px solid #dfe4ff;
            box-shadow: 0 14px 32px rgba(26, 35, 126, 0.08);
        }

        .legal-assistant-section h5 {
            font-size: 1rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .legal-assistant-section p {
            font-size: 0.9rem;
            line-height: 1.65;
            color: #333;
        }

        .legal-assistant-section + .legal-assistant-section {
            margin-top: 1rem;
        }

        .legal-assistant-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            background: rgba(102, 126, 234, 0.15);
            color: var(--primary-color);
            font-weight: 700;
            font-size: 0.85rem;
        }

        .legal-assistant-list {
            margin: 0.5rem 0 0 1.2rem;
            display: grid;
            gap: 0.35rem;
        }

        .legal-assistant-document-actions {
            display: none;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .legal-assistant-document-actions.active {
            display: flex;
        }

        .legal-assistant-preview-wrapper {
            margin-top: 1.5rem;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #dfe4ff;
            box-shadow: inset 0 0 0 1px rgba(102, 126, 234, 0.08);
        }

        .legal-assistant-preview {
            width: 100%;
            min-height: 320px;
            border: none;
            background: white;
        }

        .legal-assistant-error {
            background: rgba(244, 67, 54, 0.12);
            border-left: 4px solid #f44336;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            color: #b71c1c;
            font-weight: 600;
            line-height: 1.6;
        }

        .legal-assistant-raw {
            display: none;
            margin-top: 1.25rem;
            border-radius: 12px;
            background: #0d132e;
            color: #e8eaf6;
            font-family: 'Fira Code', monospace;
            padding: 1rem;
            font-size: 0.78rem;
            max-height: 240px;
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .legal-assistant-grid {
                grid-template-columns: 1fr;
            }

            .legal-assistant-primary-actions .btn {
                flex: 1;
                min-width: 160px;
            }
        }

        @media (max-width: 768px) {
            .legal-assistant-content {
                padding: 1.5rem;
            }

            .legal-assistant-panel {
                padding: 1.25rem;
            }

            .legal-assistant-document-actions {
                flex-direction: column;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 2rem;
            color: var(--primary-color);
            font-weight: 800;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: var(--transition);
        }

        .btn-close:hover {
            color: var(--danger-color);
            transform: rotate(90deg);
        }

        /* Footer */
        footer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        footer p {
            color: #666;
            font-weight: 600;
        }

        /* Proposals Tracking */
        .proposals-tracking {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            animation: fadeInUp 0.5s ease 0.5s backwards;
        }

        .proposals-tracking.highlighted {
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.25), var(--card-shadow);
            transition: box-shadow 0.4s ease;
        }

        .tracking-header {
            margin-bottom: 1.5rem;
        }

        .tracking-header h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .tracking-subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        .proposals-list {
            display: grid;
            gap: 1rem;
        }

        .proposal-track-card {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 1.5rem;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s;
        }

        .proposal-track-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .proposal-track-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .proposal-track-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            flex: 1;
        }

        .proposal-track-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.75rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .info-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: #333;
        }

        .status-badge-track {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .status-aguardando {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-publicado {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-vigor {
            background: #e3f2fd;
            color: #1565c0;
        }

        .proposal-track-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-mark-published {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
        }

        .btn-mark-published:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .document-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .document-link:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                min-width: 100%;
                padding: 1rem;
                font-size: 1rem;
                touch-action: manipulation;
            }

            .budget-amount {
                font-size: 2.5rem;
            }
            
            .card-value {
                font-size: 1.8rem;
            }

            table {
                font-size: 0.85rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            thead, tbody, tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

            th, td {
                padding: 0.5rem 0.3rem;
                font-size: 0.75rem;
                max-width: none;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            th:first-child, td:first-child {
                min-width: 120px;
            }

            th:nth-child(2), td:nth-child(2),
            th:nth-child(3), td:nth-child(3),
            th:nth-child(4), td:nth-child(4) {
                min-width: 90px;
            }

            th:nth-child(5), td:nth-child(5) {
                min-width: 70px;
            }

            th:nth-child(6), td:nth-child(6) {
                min-width: 80px;
            }
            
            .logo-text h1 {
                font-size: 1.2rem;
            }
            
            .logo-text p {
                font-size: 0.75rem;
            }
            
            .user-badge {
                font-size: 0.85rem;
                padding: 0.4rem 1rem;
            }
            
            .indicators-grid {
                grid-template-columns: 1fr;
            }

            .btn-notif {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }

            .btn-logout {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }

            .notifications-panel {
                width: 100vw;
                right: 0;
                left: 0;
                top: 60px;
                max-width: none;
                border-radius: 0;
                max-height: calc(100vh - 60px);
            }

            .ministry-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .ministry-table table {
                min-width: 800px;
            }
        }
        
        @media (max-width: 480px) {
            .budget-amount {
                font-size: 1.8rem;
            }
            
            .card-value {
                font-size: 1.5rem;
            }
            
            .container {
                padding: 0 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .budget-showcase {
                padding: 2rem 1.5rem;
            }

            header {
                padding: 0.75rem 1rem;
            }

            .logo-badge {
                width: 35px;
                height: 35px;
            }

            .user-info {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .btn-notif {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                margin-right: 0.5rem;
            }

            .notification-badge {
                width: 20px;
                height: 20px;
                font-size: 0.7rem;
            }

            .notifications-panel {
                top: 50px;
                max-height: calc(100vh - 50px);
            }

            .notifications-list {
                max-height: calc(100vh - 150px);
            }

            th, td {
                font-size: 0.7rem;
                padding: 0.4rem 0.2rem;
            }

            .ministry-table {
                padding: 1rem;
            }

            .ministry-table h2 {
                font-size: 1.1rem;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-gradient);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Notifications Panel */
        .notifications-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            max-height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideInRight 0.3s ease;
            overflow: hidden;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notifications-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
        }

        .btn-close-notif {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-close-notif:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .notifications-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
        }

        .notification-item {
            background: #f8f9ff;
            border: none;
            border-left: 4px solid #667eea;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 0.9rem;
            width: 100%;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border-color 0.2s ease;
            text-align: left;
            font-family: inherit;
        }

        .notification-item:hover {
            transform: translateX(5px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.18);
        }

        .notification-item:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.35);
        }

        .notification-item.unread {
            background: #eef2ff;
            border-left-color: #3f51b5;
            box-shadow: 0 10px 26px rgba(63, 81, 181, 0.18);
        }

        .notification-item.success {
            border-left-color: #4caf50;
        }

        .notification-item.warning {
            background: #fff8e1;
            border-left-color: #ff9800;
        }

        .notification-item.error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .notification-icon {
            font-size: 1.6rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: rgba(102, 126, 234, 0.12);
            flex-shrink: 0;
        }

        .notification-item.success .notification-icon {
            background: rgba(76, 175, 80, 0.12);
        }

        .notification-item.warning .notification-icon {
            background: rgba(255, 152, 0, 0.16);
        }

        .notification-item.error .notification-icon {
            background: rgba(244, 67, 54, 0.14);
        }

        .notification-action {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            margin-top: 0.6rem;
            font-size: 0.78rem;
            font-weight: 600;
            color: #3f51b5;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .notification-action::after {
            content: '‚Üí';
            font-size: 0.8rem;
        }

        .notification-feedback {
            margin-top: 0.6rem;
            padding: 0.75rem 0.9rem;
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.12);
            color: #2f3c7e;
            font-size: 0.82rem;
            font-weight: 500;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .notification-item.warning .notification-feedback {
            background: rgba(255, 152, 0, 0.18);
            color: #8b5a13;
        }

        .notification-item.error .notification-feedback {
            background: rgba(244, 67, 54, 0.16);
            color: #b71c1c;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-title {
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .notification-message {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.5;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.5rem;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(244, 67, 54, 0);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Carregando Sistema...</div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-badge"></div>
                <div class="logo-text">
                    <h1>Governo Federal Chocotone</h1>
                    <p>Sistema de Gest√£o Or√ßament√°ria</p>
                </div>
            </div>
            <div class="user-info">
                <button id="btnNotifications" class="btn-notif" onclick="toggleNotifications()" style="position: relative; margin-right: 1rem;">
                    üîî
                    <span id="notificationBadge" class="notification-badge" style="display: none;"></span>
                </button>
                <div class="user-badge">
                    <img id="userHabboAvatar" class="user-habbo-avatar" src="" alt="Avatar" style="display: none;">
                    <div>
                        <span id="userName">Visitante</span>
                        <span class="user-role" id="userRole">Sem permiss√£o</span>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">Sair</button>
            </div>
        </div>
    </header>

    <!-- Notifications Panel -->
    <div id="notificationsPanel" class="notifications-panel" style="display: none;">
        <div class="notifications-header">
            <h3>üîî Notifica√ß√µes</h3>
            <button onclick="closeNotifications()" class="btn-close-notif">√ó</button>
        </div>
        <div id="notificationsList" class="notifications-list">
            <!-- Ser√° preenchido via JavaScript -->
        </div>
        <div style="padding: 1rem; border-top: 1px solid #eee; text-align: center;">
            <button onclick="markAllNotificationsAsRead()" class="btn" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                ‚úì Marcar Todas como Lidas
            </button>
        </div>
    </div>

    <div id="notificationModal" class="modal" aria-hidden="true">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <div class="modal-title" id="notificationModalTitle">Notifica√ß√£o</div>
                <button class="btn-close" onclick="closeNotificationModal()">&times;</button>
            </div>
            <div class="modal-body" id="notificationModalBody"></div>
            <div class="modal-actions" id="notificationModalActions" style="display: none;"></div>
        </div>
    </div>

    <div id="adjustmentModal" class="modal" aria-hidden="true">
        <div class="modal-content adjustment-modal-content">
            <div class="modal-header">
                <div class="modal-title">Reenviar Proposta Ajustada</div>
                <button class="btn-close" onclick="closeAdjustmentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="adjustmentFeedbackMessage" class="adjustment-feedback" style="display: none;"></div>

                <div class="adjustment-meta">
                    <div class="adjustment-meta-item">
                        <div class="adjustment-meta-label">Documento</div>
                        <div class="adjustment-meta-value" id="adjustmentProposalTitle">-</div>
                    </div>
                    <div class="adjustment-meta-item">
                        <div class="adjustment-meta-label">Minist√©rio</div>
                        <div class="adjustment-meta-value" id="adjustmentProposalMinistry">-</div>
                    </div>
                    <div class="adjustment-meta-item">
                        <div class="adjustment-meta-label">Solicitante</div>
                        <div class="adjustment-meta-value" id="adjustmentProposalOwner">-</div>
                    </div>
                    <div class="adjustment-meta-item">
                        <div class="adjustment-meta-label">Valor Atual</div>
                        <div class="adjustment-meta-value" id="adjustmentProposalCost">R$ 0,00</div>
                    </div>
                </div>

                <div id="adjustmentErrorMessage" class="adjustment-error"></div>

                <div class="adjustment-form-group">
                    <label class="adjustment-label" for="adjustSummaryInput">Resumo Atualizado *</label>
                    <textarea id="adjustSummaryInput" class="adjustment-textarea" placeholder="Descreva brevemente o objetivo da proposta" required></textarea>
                </div>

                <div class="adjustment-form-group">
                    <label class="adjustment-label" for="adjustCostInput">Custo Estimado (R$) *</label>
                    <input type="number" id="adjustCostInput" class="adjustment-input" min="0" step="0.01" required>
                    <span class="adjustment-helper" id="adjustCostHelper">Informe o custo total previsto para execu√ß√£o.</span>
                </div>

                <div class="adjustment-form-group">
                    <label class="adjustment-label" for="adjustJustificationInput">Justificativa *</label>
                    <textarea id="adjustJustificationInput" class="adjustment-textarea" placeholder="Explique brevemente o impacto e necessidade da proposta" required></textarea>
                </div>

                <div class="adjustment-form-group">
                    <label class="adjustment-label" for="adjustBodyInput">Descri√ß√£o Completa *</label>
                    <textarea id="adjustBodyInput" class="adjustment-textarea" style="min-height: 180px;" placeholder="Detalhe os principais pontos, etapas e respons√°veis" required></textarea>
                </div>
            </div>
            <div class="modal-actions adjustment-actions">
                <button id="adjustmentSubmitButton" class="btn btn-modal btn-approve" onclick="submitProposalAdjustment()">
                    üîÅ Reenviar Proposta
                </button>
                <button class="btn btn-modal" style="background: #e0e0e0; color: #555;" onclick="closeAdjustmentModal()">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <div id="legalAssistantModal" class="modal" aria-hidden="true">
        <div class="modal-content legal-assistant-content">
            <div class="modal-header">
                <div class="modal-title">Assistente de Atos Oficiais</div>
                <button class="btn-close" id="legalAssistantCloseIcon" onclick="closeLegalAssistant()">&times;</button>
            </div>
            <div class="modal-body legal-assistant-body">
                <form id="legalAssistantForm" novalidate>
                    <div class="legal-assistant-grid">
                        <div class="legal-assistant-panel">
                            <div class="legal-assistant-field">
                                <label class="legal-assistant-label" for="legalAssistantAuthor">Autor respons√°vel *</label>
                                <select class="legal-assistant-select" id="legalAssistantAuthor" name="legalAssistantAuthor" required></select>
                                <div class="legal-assistant-helper">Selecione quem lidera o ato. Se for voc√™, confirme o seu nome.</div>
                            </div>
                            <div class="legal-assistant-field">
                                <label class="legal-assistant-label" for="legalAssistantRecipients">Destinat√°rio(s) principais</label>
                                <input type="text" class="legal-assistant-input" id="legalAssistantRecipients" name="legalAssistantRecipients" placeholder="Ex.: Presidenta da Rep√∫blica, Congresso Nacional, Governadores...">
                            </div>
                            <div class="legal-assistant-field">
                                <label class="legal-assistant-label" for="legalAssistantContext">Contexto detalhado *</label>
                                <textarea class="legal-assistant-textarea" id="legalAssistantContext" name="legalAssistantContext" required placeholder="Descreva o cen√°rio, fatos relevantes, base legal conhecida, prazos, riscos..."></textarea>
                                <div class="legal-assistant-helper">Quanto mais contexto, melhor a recomenda√ß√£o.</div>
                            </div>
                            <div class="legal-assistant-field">
                                <label class="legal-assistant-label" for="legalAssistantGoal">Objetivo / resultado esperado</label>
                                <textarea class="legal-assistant-textarea" id="legalAssistantGoal" name="legalAssistantGoal" placeholder="Informe o resultado desejado, pol√≠ticas a serem implementadas, metas..."></textarea>
                            </div>
                            <div class="legal-assistant-field">
                                <label class="legal-assistant-label" for="legalAssistantImpact">Impacto or√ßament√°rio estimado</label>
                                <input type="text" class="legal-assistant-input" id="legalAssistantImpact" name="legalAssistantImpact" placeholder="Ex.: R$ 25.000.000 em 2025, sem impacto permanente">
                            </div>
                            <div class="legal-assistant-field">
                                <label class="legal-assistant-label" for="legalAssistantPreferred">Prefer√™ncia de instrumento</label>
                                <select class="legal-assistant-select" id="legalAssistantPreferred" name="legalAssistantPreferred">
                                    <option value="">Sem prefer√™ncia (IA decide)</option>
                                    <option value="Of√≠cio">Of√≠cio</option>
                                    <option value="Portaria">Portaria</option>
                                    <option value="Decreto Presidencial">Decreto Presidencial</option>
                                    <option value="Medida Provis√≥ria">Medida Provis√≥ria</option>
                                    <option value="Lei Ordin√°ria">Lei Ordin√°ria</option>
                                    <option value="Resolu√ß√£o">Resolu√ß√£o</option>
                                </select>
                            </div>
                            <div class="legal-assistant-field">
                                <label class="legal-assistant-label">Assinaturas necess√°rias</label>
                                <div id="legalAssistantSignerList" class="legal-assistant-signers" role="group" aria-label="Assinaturas necess√°rias"></div>
                                <div class="legal-assistant-helper">Marque quem deve assinar a minuta. A assinatura do autor √© inclu√≠da automaticamente.</div>
                            </div>
                            <div class="legal-assistant-field">
                                <label class="legal-assistant-label" for="legalAssistantNotes">Observa√ß√µes adicionais</label>
                                <textarea class="legal-assistant-textarea" id="legalAssistantNotes" name="legalAssistantNotes" placeholder="Restri√ß√µes pol√≠ticas, prazos, conex√µes com legisla√ß√µes ou decis√µes anteriores..."></textarea>
                            </div>
                            <div class="legal-assistant-primary-actions">
                                <button type="submit" class="btn btn-primary" id="legalAssistantSubmit">‚öôÔ∏è Gerar minuta</button>
                                <button type="button" class="btn btn-secondary" id="legalAssistantResetBtn" onclick="resetLegalAssistantForm()">‚Ü∫ Limpar</button>
                                <button type="button" class="btn" id="legalAssistantCloseBtn" onclick="closeLegalAssistant()">Fechar</button>
                            </div>
                        </div>
                        <div class="legal-assistant-panel legal-assistant-panel--result">
                            <div id="legalAssistantStatus" class="legal-assistant-status" role="status" aria-live="polite"></div>
                            <div id="legalAssistantResult" class="legal-assistant-result"></div>
                            <div id="legalAssistantDocActions" class="legal-assistant-document-actions">
                                <button type="button" class="btn btn-secondary" id="legalAssistantOpenBtn" onclick="openLegalAssistantDocument()" disabled>üåê Abrir HTML formatado</button>
                                <button type="button" class="btn" id="legalAssistantDownloadBtn" onclick="downloadLegalAssistantDocument()" disabled>‚¨áÔ∏è Baixar HTML</button>
                                <button type="button" class="btn" id="legalAssistantCopyBtn" onclick="copyLegalAssistantHtml()" disabled>üìã Copiar HTML</button>
                            </div>
                            <div id="legalAssistantPreviewWrapper" class="legal-assistant-preview-wrapper" style="display: none;">
                                <iframe id="legalAssistantPreview" class="legal-assistant-preview" sandbox=""></iframe>
                            </div>
                            <div id="legalAssistantRaw" class="legal-assistant-raw"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Budget Showcase -->
        <div class="budget-showcase">
            <div class="budget-label">Or√ßamento Total Dispon√≠vel</div>
            <div class="budget-amount" id="totalBudget">R$ 0,00</div>
            <div class="budget-date" id="currentDate">Atualizado em: --</div>
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #f0f0f0;">
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; font-weight: 600;">
                    ‚öñÔ∏è Teto de Gastos Constitucional
                </div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #f44336;" id="spendingCeiling">
                    R$ 1,900 trilh√£o
                </div>
                <div style="font-size: 0.85rem; color: #999; margin-top: 0.5rem;">
                    <span id="ceilingPercentage">0%</span> do teto utilizado
                </div>
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Receita Total</span>
                    <span class="card-icon">üí∞</span>
                </div>
                <div class="card-value" id="totalRevenue">R$ 0</div>
                <div class="card-subtitle">Projetado para 2025</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Despesa Total</span>
                    <span class="card-icon">üìä</span>
                </div>
                <div class="card-value" id="totalExpense">R$ 0</div>
                <div class="card-subtitle">Gastos acumulados</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="expenseProgress" style="width: 0%"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">Super√°vit Prim√°rio</span>
                    <span class="card-icon">üìà</span>
                </div>
                <div class="card-value" id="surplus">R$ 0</div>
                <div class="card-subtitle">Meta de amortiza√ß√£o da d√≠vida</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-title">D√≠vida/PIB</span>
                    <span class="card-icon">üìâ</span>
                </div>
                <div class="card-value" id="debtGDP">0%</div>
                <div class="card-subtitle" id="debtStatus">Em redu√ß√£o</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 81.5%; background: linear-gradient(90deg, #f44336, #ff9800, #4caf50)"></div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="openSubmitProposal()">
                üìù Submeter Proposta
            </button>
            <button class="btn btn-secondary" onclick="openExtract()">
                üìÑ Ver Extrato Completo
            </button>
            <button class="btn btn-ia" onclick="openLegalAssistant()">
                ü§ñ Aux√≠lio IA de Atos
            </button>
            <button class="btn btn-admin" onclick="openAdminPanel()" id="btnAdmin" style="display: none;">
                ‚öôÔ∏è Painel Administrativo
            </button>
        </div>

        <!-- Ministry Budget Table -->
        <div class="ministry-table">
            <h2>üíº Or√ßamento por Minist√©rio</h2>
            <table id="ministryTable">
                <thead>
                    <tr>
                        <th>Minist√©rio</th>
                        <th>Or√ßamento Total</th>
                        <th>Gasto</th>
                        <th>Dispon√≠vel</th>
                        <th>% Executado</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="ministryTableBody">
                    <!-- Ser√° preenchido via JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Proposals Implementation Tracking -->
        <div class="proposals-tracking" id="proposalsTracking" style="display: none;">
            <div class="tracking-header">
                <h2>üìã Acompanhamento de Propostas Aprovadas</h2>
                <p class="tracking-subtitle">Status de publica√ß√£o no System Oficial</p>
            </div>
            <div id="proposalsList" class="proposals-list">
                <!-- Ser√° preenchido via JavaScript -->
            </div>
        </div>

        <!-- Economic Indicators -->
        <div class="indicators-section">
            <div class="indicators-header">
                <h2>üìä Indicadores Econ√¥micos</h2>
                <div class="indicator-actions">
                    <button class="btn-update-indicators" id="btnUpdateIndicators" onclick="updateIndicators('manual')" style="display: none;">
                        üîÑ Atualizar Agora
                    </button>
                    <span id="indicatorsStatus" class="indicator-status" aria-live="polite"></span>
                </div>
            </div>
            <div class="indicators-grid" id="indicatorsGrid">
                <!-- Ser√° preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <!-- ChocoBot Iframe -->
    <iframe 
        id="chocobotFrame" 
        src="chocobot.html" 
        style="position: fixed; bottom: 0; right: 0; width: 100%; height: 100%; border: none; pointer-events: none; z-index: 9997;"
        allow="clipboard-write"
    ></iframe>

    <!-- Bot√£o ChocoBot (clone fora do iframe para funcionar) -->
    <button id="chocobotButtonClone" style="
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        border: 3px solid white;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        animation: pulse-glow 2s infinite;
        overflow: hidden;
        padding: 5px;
        border: none;
    ">
        <img src="https://www.habbo.com.br/habbo-imaging/avatarimage?user=Chocotone&direction=2&head_direction=3&gesture=sml&size=l" 
             alt="ChocoBot" 
             style="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated;">
    </button>

    <style>
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 8px 35px rgba(102, 126, 234, 0.7); }
        }
        #chocobotButtonClone:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }
    </style>

    <!-- Footer -->
    <footer>
        <p>¬© 2025 Governo Federal Chocotone | Sistema de Gest√£o Or√ßament√°ria v1.0</p>
        <p>Desenvolvido com üíú para o Congresso Nacional Habbo</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, getDocs, getDoc, doc, updateDoc, addDoc, serverTimestamp, orderBy, writeBatch, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { LEGAL_CONTEXT } from './chocobot-context.js';

        const firebaseConfig = {
          apiKey: "AIzaSyBLmX8UGHzmnMkLy16t3SwojA6u67lyvVA",
          authDomain: "governo-chocotone.firebaseapp.com",
          projectId: "governo-chocotone",
          storageBucket: "governo-chocotone.firebasestorage.app",
          messagingSenderId: "829728497507",
          appId: "1:829728497507:web:5689c0ad79c42dbe583d56"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Configura√ß√µes
        const CONFIG = {
            INDICATORS_API: 'https://congressohb.com.br/api/economic-ai/indicators?period=hour',
            UPDATE_INTERVAL: 3600000, // 1 hora em ms
            SPENDING_CEILING: 1900000000000, // Teto de gastos R$ 1.9 trilh√£o
            LOA_DATA: {
                totalRevenue: 4392000000000,
                totalExpense: 1900000000000,
                surplus: 2192000000000
            }
        };

        const AI_CONFIG = {
            PROXY_URL: 'https://chocobot-proxy.bryandosouros.workers.dev',
            MODEL: 'openrouter/polaris-alpha',
            TEMPERATURE: 0.35,
            MAX_TOKENS: 2200
        };

        const LEGAL_ASSISTANT_SYSTEM_PROMPT = `
Voc√™ √© o m√≥dulo "Atos Oficiais IA" do Governo Federal Chocotone (RPG Habbo). Aja como assessor jur√≠dico-legislativo s√™nior do Poder Executivo.
Objetivos principais:
1. Avaliar o contexto fornecido e identificar qual instrumento normativo √© mais adequado (of√≠cio, portaria, decreto presidencial, medida provis√≥ria, lei ordin√°ria, resolu√ß√£o ou outro).
2. Justificar a escolha com base na Constitui√ß√£o Federal RPG, c√≥digos correlatos e compet√™ncias administrativas.
3. Explicar a constitucionalidade, riscos e requisitos formais (inclusive necessidade de aprecia√ß√£o legislativa ou controle).
4. Elaborar minuta completa do ato selecionado (t√≠tulo, ementa, considerandos, artigos numerados, dispositivos finais e bloco de assinaturas com os nicks Habbo indicados).
5. Orientar pr√≥ximos passos administrativos ou legislativos quando cab√≠vel.

Regras obrigat√≥rias de resposta:
- RESPONDA EXCLUSIVAMENTE em JSON v√°lido (sem texto fora do JSON e sem blocos de c√≥digo).
- Utilize exatamente a estrutura abaixo (sempre incluir todos os campos, mesmo vazios quando inaplic√°veis):
{
  "recommendedInstrument": {
    "type": "Of√≠cio",
    "confidence": "alta",
    "summary": "Resumo da recomenda√ß√£o",
    "alternatives": ["Portaria", "Decreto Presidencial"]
  },
  "constitutionalAnalysis": {
    "status": "constitucional",
    "explanation": "An√°lise detalhada",
    "references": ["CF-RPG art. 12", "CF-RPG art. 45"],
    "alerts": ["Risco or√ßament√°rio se n√£o houver dota√ß√£o"]
  },
  "budgetAssessment": {
    "impactSummary": "Descri√ß√£o do impacto",
    "ceilingCompatibility": "dentro_do_teto",
    "observations": ["Sugest√£o de fonte de custeio"]
  },
  "draft": {
    "title": "T√çTULO DO ATO",
    "ementa": "Ementa sint√©tica",
    "considerandos": ["Considerando 1", "Considerando 2"],
    "articles": [
      {"number": 1, "text": "Dispositivo com comandos detalhados"},
      {"number": 2, "text": "Outro dispositivo necess√°rio"}
    ],
    "finalDisposition": "Cl√°usula de vig√™ncia ou encaminhamento",
    "signatures": [
      {"name": "Chocotone", "role": "Presidenta da Rep√∫blica", "habboNick": "Chocotone"}
    ]
  },
  "nextSteps": ["Provid√™ncia 1", "Provid√™ncia 2"],
  "htmlDocument": "<!DOCTYPE html>...HTML completo com estilos inline..."
}

Diretrizes adicionais:
- Estruture os artigos em ordem num√©rica crescente, sempre come√ßando no artigo 1.¬∫.
- Se o ato for invi√°vel ou inconstitucional, defina "status" como "inviavel" e deixe o objeto "draft" com campos vazios, mas mantenha o JSON v√°lido e proponha alternativas em "nextSteps".
- Garanta que "htmlDocument" seja um documento HTML completo, pronto para impress√£o (estilos inline √∫teis, t√≠tulos, ementa, considerandos, artigos e assinaturas). N√£o inclua scripts.
- Utilize linguagem formal, t√©cnica e alinhada ao protocolo oficial brasileiro.
- Utilize as assinaturas fornecidas pelo usu√°rio; se faltar autoridade obrigat√≥ria, registre alerta em "constitutionalAnalysis.alerts".
- Sempre considere o conte√∫do legal fornecido a seguir (Constitui√ß√£o, c√≥digos e demais anexos).
`;

        const GOVERNMENT_MEMBERS = [
            {
                id: 'Chocotone',
                displayName: 'Chocotone',
                habboNick: 'Chocotone',
                role: 'Presidenta da Rep√∫blica',
                signatureTitle: 'Presidenta da Rep√∫blica',
                ministry: 'Gabinete da Presid√™ncia',
                category: 'presidency'
            },
            {
                id: 'Bryan dos Ouros',
                displayName: 'Bryan dos Ouros',
                habboNick: 'Bryan dos Ouros',
                role: 'Vice-Presidente da Rep√∫blica e Ministro-Chefe da Casa Civil',
                signatureTitle: 'Vice-Presidente da Rep√∫blica e Ministro-Chefe da Casa Civil',
                ministry: 'Casa Civil',
                category: 'presidency'
            },
            {
                id: '-Furia-',
                displayName: '-Furia-',
                habboNick: '-Furia-',
                role: 'Ministro da Economia e Trabalho',
                signatureTitle: 'Ministro da Economia e Trabalho',
                ministry: 'Economia e Trabalho',
                category: 'minister'
            },
            {
                id: 'joaobatistagc',
                displayName: 'joaobatistagc',
                habboNick: 'joaobatistagc',
                role: 'Ministra da Sa√∫de',
                signatureTitle: 'Ministra da Sa√∫de',
                ministry: 'Sa√∫de',
                category: 'minister'
            },
            {
                id: 'Stroch',
                displayName: 'Stroch',
                habboNick: 'Stroch',
                role: 'Ministro da Educa√ß√£o, Ci√™ncia e Tecnologia',
                signatureTitle: 'Ministro da Educa√ß√£o, Ci√™ncia e Tecnologia',
                ministry: 'Educa√ß√£o, Ci√™ncia e Tecnologia',
                category: 'minister'
            },
            {
                id: 'Nyxalis',
                displayName: 'Nyxalis',
                habboNick: 'Nyxalis',
                role: 'Ministra da Cidadania, Desenvolvimento Social, Direitos Humanos e Povos Origin√°rios',
                signatureTitle: 'Ministra da Cidadania, Desenvolvimento Social, Direitos Humanos e Povos Origin√°rios',
                ministry: 'Cidadania, Desenvolvimento Social, Direitos Humanos e Povos Origin√°rios',
                category: 'minister'
            },
            {
                id: 'MalopRRN',
                displayName: 'MalopRRN',
                habboNick: 'MalopRRN',
                role: 'Ministro da Defesa',
                signatureTitle: 'Ministro da Defesa',
                ministry: 'Defesa',
                category: 'minister'
            },
            {
                id: 'guguinhoHop',
                displayName: 'guguinhoHop',
                habboNick: 'guguinhoHop',
                role: 'Ministro da Justi√ßa e Seguran√ßa P√∫blica',
                signatureTitle: 'Ministro da Justi√ßa e Seguran√ßa P√∫blica',
                ministry: 'Justi√ßa e Seguran√ßa P√∫blica',
                category: 'minister'
            },
            {
                id: 'Dj.Bigoreia',
                displayName: 'Dj.Bigoreia',
                habboNick: 'Dj.Bigoreia',
                role: 'Ministro da Infraestrutura',
                signatureTitle: 'Ministro da Infraestrutura',
                ministry: 'Infraestrutura',
                category: 'minister'
            },
            {
                id: 'Fabio-Blunt-UK',
                displayName: 'Fabio-Blunt-UK',
                habboNick: 'Fabio-Blunt-UK',
                role: 'Ministro da Agricultura, Meio Ambiente, Turismo e Desenvolvimento Rural',
                signatureTitle: 'Ministro da Agricultura, Meio Ambiente, Turismo e Desenvolvimento Rural',
                ministry: 'Agricultura, Meio Ambiente, Turismo e Desenvolvimento Rural',
                category: 'minister'
            },
            {
                id: 'Brenda.M',
                displayName: 'Brenda.M',
                habboNick: 'Brenda.M',
                role: 'Ministra da Cultura e Esporte',
                signatureTitle: 'Ministra da Cultura e Esporte',
                ministry: 'Cultura e Esporte',
                category: 'minister'
            },
            {
                id: 'Stallley',
                displayName: 'Stallley',
                habboNick: 'Stallley',
                role: 'Advogado-Geral da Uni√£o',
                signatureTitle: 'Advogado-Geral da Uni√£o',
                ministry: 'Advocacia-Geral da Uni√£o',
                category: 'auxiliary'
            }
        ];

        const GOVERNMENT_MEMBERS_MAP = new Map(GOVERNMENT_MEMBERS.map(member => [member.id, member]));

        const LEGAL_ASSISTANT_INSTRUMENTS = ['Of√≠cio', 'Portaria', 'Decreto Presidencial', 'Medida Provis√≥ria', 'Lei Ordin√°ria', 'Resolu√ß√£o'];

        const LEGAL_ASSISTANT_STATE = {
            isGenerating: false,
            lastHtml: '',
            lastRaw: '',
            lastResult: null
        };

        let legalAssistantInitialized = false;

        // Estado global
        let userData = {
            name: 'Visitante',
            role: 'visitor',
            ministries: []
        };

    let budgetData = [];
    let proposalsData = [];
    let notificationsData = [];
    let indicatorsData = null;
    let notificationRecipientTags = [];
    let notificationReadKey = null;
    let adjustmentState = {
        notification: null,
        proposal: null,
        isSubmitting: false
    };
    let indicatorsLoading = false;
    let unsubscribeBudgets = null;
    let unsubscribeProposals = null;
    let unsubscribeNotifications = null;

        // Fun√ß√µes de inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                checkAuth();
                const notificationModal = document.getElementById('notificationModal');
                if (notificationModal) {
                    notificationModal.addEventListener('click', (event) => {
                        if (event.target === notificationModal) {
                            closeNotificationModal();
                        }
                    });
                }
                const adjustmentModalOverlay = document.getElementById('adjustmentModal');
                if (adjustmentModalOverlay) {
                    adjustmentModalOverlay.addEventListener('click', (event) => {
                        if (event.target === adjustmentModalOverlay) {
                            closeAdjustmentModal();
                        }
                    });
                }
            }, 1500);
        });

        function checkAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const storedUser = localStorage.getItem('govUser');
                    if (storedUser) {
                        userData = JSON.parse(storedUser);
                        notificationRecipientTags = buildRecipientTags(userData);
                        notificationReadKey = null;
                        document.getElementById('userName').textContent = userData.name;
                        document.getElementById('userRole').textContent = userData.role;
                        
                        // Carregar foto do Habbo usando o username correto
                        loadHabboAvatar(userData.habboUsername || userData.name);
                        
                        if (userData.role === 'Presidenta' || userData.role === 'Vice-Presidente') {
                            document.getElementById('btnAdmin').style.display = 'block';
                            document.getElementById('btnUpdateIndicators').style.display = 'block';
                        }

                          // Iniciar listeners em realtime
                          loadBudgetsRealtime();
                          loadProposalsRealtime();
                          loadNotificationsRealtime();
                          updateIndicators('auto');
                          setInterval(() => updateIndicators('auto'), CONFIG.UPDATE_INTERVAL);
                          legalAssistantInitialize();
                    } else {
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        function loadBudgetsRealtime() {
            const q = query(collection(db, 'budgets'));
            
            unsubscribeBudgets = onSnapshot(q, (snapshot) => {
            const budgetsMap = new Map();

            snapshot.forEach((docSnap) => {
                const data = { id: docSnap.id, ...docSnap.data() };
                if (data.placeholder) return;

                const ministryName = (data.ministry || docSnap.id || '').toString().trim();
                if (!ministryName) return;

                const key = ministryName.toLowerCase();
                const totalBudget = Number(data.totalBudget || 0);
                const spent = Number(data.spent || 0);
                const available = data.available !== undefined
                    ? Number(data.available)
                    : totalBudget - spent;

                budgetsMap.set(key, {
                    id: docSnap.id,
                    ...data,
                    ministry: ministryName,
                    totalBudget,
                    spent,
                    available
                });
            });

            budgetData = Array.from(budgetsMap.values()).sort((a, b) =>
                a.ministry.localeCompare(b.ministry, 'pt-BR')
            );
                
                loadBudgetData();
                loadMinistryTable();
            }, (error) => {
                console.error('Erro ao carregar or√ßamentos:', error);
            });
        }

    function buildRecipientTags(user) {
        const tags = new Set(['all']);
        if (!user) return Array.from(tags);
        if (user.role) {
            tags.add(user.role);
            tags.add(`role:${user.role}`);
        }
        if (user.name) {
            tags.add(user.name);
            tags.add(`name:${user.name}`);
        }
        if (user.uid) {
            tags.add(user.uid);
            tags.add(`uid:${user.uid}`);
        }
        return Array.from(tags);
    }

    function getReadTrackingKey() {
        if (notificationReadKey) return notificationReadKey;
        if (userData?.uid) {
            notificationReadKey = userData.uid;
        } else if (userData?.name) {
            notificationReadKey = userData.name;
        } else if (userData?.role) {
            notificationReadKey = userData.role;
        }
        return notificationReadKey;
    }

    function hasUserReadNotification(notification) {
        if (!notification) return true;

        const readField = notification.read;
        const readByRaw = notification.readBy;
        const readByArray = Array.isArray(readByRaw)
            ? readByRaw
            : readByRaw
                ? [readByRaw]
                : [];

        const key = getReadTrackingKey();

        if (!key) {
            return Boolean(readField);
        }

        if (readByArray.includes(key)) return true;

        // Fallbacks for previous schema versions
        if (userData?.name && readByArray.includes(userData.name)) return true;
        if (userData?.role && readByArray.includes(userData.role)) return true;

        // For legacy single-recipient notifications using boolean read flag
        if (readField === true && (!notification.targetUsers || notification.targetUsers.length <= 1)) {
            return true;
        }

        return false;
    }

    function getNotificationSeverity(type) {
        switch (type) {
            case 'proposal_approved':
            case 'budget_updated':
            case 'proposal_resubmitted':
                return 'success';
            case 'proposal_needs_adjustment':
                return 'warning';
            case 'proposal_rejected':
                return 'error';
            default:
                return '';
        }
    }

    function buildNotificationMessage(notification) {
        const safeMessage = notification.message || '';
        const feedbackBlock = notification.feedback
            ? `<div class="notification-feedback">${sanitizeHtml(notification.feedback)}</div>`
            : '';

        return `${sanitizeHtml(safeMessage)}${feedbackBlock}`;
    }

    function getNotificationActionLabel(notification) {
        switch (notification.type) {
            case 'proposal_submitted':
                return 'Analisar proposta';
            case 'proposal_needs_adjustment':
                return notification.status === 'resubmitted' ? '' : 'Enviar ajustes';
            case 'proposal_rejected':
                return 'Ver detalhes';
            case 'proposal_approved':
                return 'Acompanhar execu√ß√£o';
            case 'proposal_resubmitted':
                return (userData.role === 'Presidenta' || userData.role === 'Vice-Presidente') ? 'Rever proposta' : '';
            default:
                return '';
        }
    }

    function sanitizeHtml(value) {
        if (value === null || value === undefined) return '';
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/\n/g, '<br>');
    }

        // ==== ASSISTENTE DE ATOS OFICIAIS COM IA ====
        function legalAssistantInitialize() {
            if (legalAssistantInitialized) return;

            const modal = document.getElementById('legalAssistantModal');
            const form = document.getElementById('legalAssistantForm');
            const resultContainer = document.getElementById('legalAssistantResult');

            if (!modal || !form || !resultContainer) {
                console.warn('Assistente IA: elementos do modal n√£o encontrados.');
                return;
            }

            legalAssistantInitialized = true;

            legalAssistantPopulateSelectors();
            legalAssistantRenderPlaceholder();
            legalAssistantSetStatus('Informe o contexto para receber uma minuta completa com IA.', 'info');

            const authorSelect = document.getElementById('legalAssistantAuthor');
            if (authorSelect) {
                authorSelect.addEventListener('change', (event) => {
                    if (event.target && event.target.value) {
                        legalAssistantEnsureSigner(event.target.value);
                    }
                });
            }

            form.addEventListener('submit', legalAssistantHandleSubmit);

            modal.addEventListener('click', (event) => {
                if (LEGAL_ASSISTANT_STATE.isGenerating) return;
                if (event.target === modal) {
                    closeLegalAssistant();
                }
            });

            if (userData && userData.name && GOVERNMENT_MEMBERS_MAP.has(userData.name)) {
                if (authorSelect && !authorSelect.value) {
                    authorSelect.value = userData.name;
                }
                legalAssistantEnsureSigner(userData.name);
            }
        }

        function legalAssistantPopulateSelectors() {
            const authorSelect = document.getElementById('legalAssistantAuthor');
            const signersContainer = document.getElementById('legalAssistantSignerList');
            if (!authorSelect || !signersContainer) return;

            const groups = [
                { key: 'presidency', label: 'Presid√™ncia', members: [] },
                { key: 'minister', label: 'Ministros de Estado', members: [] },
                { key: 'auxiliary', label: '√ìrg√£os Essenciais', members: [] }
            ];
            const fallbackGroup = { key: 'other', label: 'Demais autoridades', members: [] };

            GOVERNMENT_MEMBERS.forEach((member) => {
                const target = groups.find((group) => group.key === member.category) || fallbackGroup;
                target.members.push(member);
            });

            authorSelect.innerHTML = '<option value="">Selecione...</option>';

            [...groups, fallbackGroup].forEach((group) => {
                if (!group.members.length) return;
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.label;
                group.members
                    .slice()
                    .sort((a, b) => a.displayName.localeCompare(b.displayName, 'pt-BR'))
                    .forEach((member) => {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.displayName} (${member.role})`;
                        optgroup.appendChild(option);
                    });
                authorSelect.appendChild(optgroup);
            });

            signersContainer.innerHTML = '';

            [...groups, fallbackGroup].forEach((group) => {
                if (!group.members.length) return;

                const title = document.createElement('div');
                title.className = 'legal-assistant-signer-group-title';
                title.textContent = group.label;
                signersContainer.appendChild(title);

                group.members
                    .slice()
                    .sort((a, b) => a.displayName.localeCompare(b.displayName, 'pt-BR'))
                    .forEach((member) => {
                        const label = document.createElement('label');
                        label.className = 'legal-assistant-signer';
                        label.dataset.memberId = member.id;

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'legalAssistantSigners';
                        checkbox.value = member.id;

                        checkbox.addEventListener('change', () => {
                            label.classList.toggle('active', checkbox.checked);
                        });

                        const info = document.createElement('div');
                        info.className = 'legal-assistant-signer-info';

                        const nameEl = document.createElement('div');
                        nameEl.className = 'legal-assistant-signer-name';
                        nameEl.textContent = member.displayName;

                        const roleEl = document.createElement('div');
                        roleEl.className = 'legal-assistant-signer-role';
                        roleEl.textContent = member.role;

                        const habboEl = document.createElement('div');
                        habboEl.className = 'legal-assistant-signer-habbo';
                        habboEl.textContent = `Habbo: ${member.habboNick}`;

                        info.appendChild(nameEl);
                        info.appendChild(roleEl);
                        info.appendChild(habboEl);

                        label.appendChild(checkbox);
                        label.appendChild(info);
                        signersContainer.appendChild(label);
                    });
            });
        }

        function legalAssistantEnsureSigner(memberId) {
            if (!memberId) return;
            const checkboxes = legalAssistantGetSignerCheckboxes();
            let hasMatch = false;
            checkboxes.forEach((checkbox) => {
                if (checkbox.value === memberId) {
                    if (!checkbox.checked) {
                        checkbox.checked = true;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                    hasMatch = true;
                }
            });
            if (!hasMatch && userData && userData.name === memberId) {
                // Autor n√£o listado, nenhum checkbox dispon√≠vel.
            }
        }

        function legalAssistantGetSignerCheckboxes() {
            return Array.from(document.querySelectorAll('#legalAssistantSignerList input[name="legalAssistantSigners"]'));
        }

        function legalAssistantRenderPlaceholder() {
            const container = document.getElementById('legalAssistantResult');
            const rawContainer = document.getElementById('legalAssistantRaw');
            const previewWrapper = document.getElementById('legalAssistantPreviewWrapper');
            const previewFrame = document.getElementById('legalAssistantPreview');

            if (container) {
                container.innerHTML = `
                    <div class="legal-assistant-placeholder">
                        <div style="font-size: 2.5rem;">ü§ñ</div>
                        <strong>Assistente jur√≠dico pronto para atuar</strong>
                        <p>Preencha os campos ao lado e clique em "Gerar minuta" para receber o ato adequado, an√°lise de constitucionalidade e HTML pronto para publica√ß√£o.</p>
                        <p style="font-size: 0.85rem;">A IA utiliza automaticamente a Constitui√ß√£o Federal RPG, C√≥digo Penal, C√≥digo Civil, or√ßamentos e indicadores oficiais.</p>
                    </div>
                `;
            }

            if (rawContainer) {
                rawContainer.style.display = 'none';
                rawContainer.textContent = '';
            }

            if (previewWrapper && previewFrame) {
                previewFrame.srcdoc = '';
                previewWrapper.style.display = 'none';
            }

            LEGAL_ASSISTANT_STATE.lastHtml = '';
            LEGAL_ASSISTANT_STATE.lastRaw = '';
            LEGAL_ASSISTANT_STATE.lastResult = null;
            legalAssistantUpdateDocActions(false);
        }

        function legalAssistantRenderLoadingView() {
            const container = document.getElementById('legalAssistantResult');
            const rawContainer = document.getElementById('legalAssistantRaw');

            if (container) {
                container.innerHTML = `
                    <div class="legal-assistant-loading">
                        <div class="legal-assistant-spinner"></div>
                        <p>Consultando a intelig√™ncia jur√≠dica do governo...</p>
                        <p class="legal-assistant-helper">Isso pode levar alguns segundos.</p>
                    </div>
                `;
            }

            if (rawContainer) {
                rawContainer.style.display = 'none';
                rawContainer.textContent = '';
            }
        }

        function legalAssistantSetStatus(message, variant = 'info') {
            const statusEl = document.getElementById('legalAssistantStatus');
            if (!statusEl) return;
            statusEl.textContent = message || '';
            statusEl.classList.remove('success', 'error', 'info');
            if (message) {
                statusEl.classList.add(variant);
            }
        }

        function legalAssistantUpdateDocActions(hasResult) {
            const actions = document.getElementById('legalAssistantDocActions');
            if (!actions) return;
            const available = Boolean(hasResult);
            actions.classList.toggle('active', available);
            actions.querySelectorAll('button').forEach((button) => {
                button.disabled = !available;
            });
        }

        function legalAssistantSetLoading(isLoading) {
            LEGAL_ASSISTANT_STATE.isGenerating = isLoading;
            const submitButton = document.getElementById('legalAssistantSubmit');
            const resetButton = document.getElementById('legalAssistantResetBtn');
            const closeButton = document.getElementById('legalAssistantCloseBtn');
            const closeIcon = document.getElementById('legalAssistantCloseIcon');

            if (submitButton) {
                submitButton.disabled = isLoading;
                submitButton.textContent = isLoading ? '‚è≥ Gerando minuta...' : '‚öôÔ∏è Gerar minuta';
            }
            if (resetButton) {
                resetButton.disabled = isLoading;
            }
            if (closeButton) {
                closeButton.disabled = isLoading;
            }
            if (closeIcon) {
                closeIcon.disabled = isLoading;
            }
        }

        function legalAssistantCollectFormData(form) {
            return {
                authorId: (form.elements['legalAssistantAuthor']?.value || '').trim(),
                recipients: (form.elements['legalAssistantRecipients']?.value || '').trim(),
                context: (form.elements['legalAssistantContext']?.value || '').trim(),
                goal: (form.elements['legalAssistantGoal']?.value || '').trim(),
                impact: (form.elements['legalAssistantImpact']?.value || '').trim(),
                preferred: (form.elements['legalAssistantPreferred']?.value || '').trim(),
                notes: (form.elements['legalAssistantNotes']?.value || '').trim(),
                signerIds: legalAssistantGetSignerCheckboxes()
                    .filter((checkbox) => checkbox.checked)
                    .map((checkbox) => checkbox.value)
            };
        }

        async function legalAssistantHandleSubmit(event) {
            event.preventDefault();
            if (LEGAL_ASSISTANT_STATE.isGenerating) return;

            const form = event.target;
            const data = legalAssistantCollectFormData(form);

            if (!data.context || data.context.length < 20) {
                legalAssistantSetStatus('Descreva o contexto com pelo menos 20 caracteres.', 'error');
                return;
            }

            let authorId = data.authorId;
            if (!authorId && userData && userData.name && GOVERNMENT_MEMBERS_MAP.has(userData.name)) {
                authorId = userData.name;
                const authorSelect = document.getElementById('legalAssistantAuthor');
                if (authorSelect) {
                    authorSelect.value = authorId;
                }
            }

            if (!authorId) {
                legalAssistantSetStatus('Selecione o autor respons√°vel pelo ato.', 'error');
                return;
            }

            const authorMember = legalAssistantGetMember(authorId);
            const resolvedAuthor = authorMember || {
                id: authorId,
                displayName: authorId,
                habboNick: userData?.habboUsername || authorId,
                role: userData?.role || 'Autor do ato',
                signatureTitle: userData?.role || 'Autor do ato',
                ministry: Array.isArray(userData?.ministries) && userData.ministries.length
                    ? userData.ministries[0]
                    : (typeof userData?.ministries === 'string' ? userData.ministries : '')
            };

            const signerIds = Array.from(new Set([...data.signerIds, resolvedAuthor.id].filter(Boolean)));
            const signers = signerIds
                .map((id) => legalAssistantGetMember(id))
                .filter(Boolean);
            const manualSigners = signerIds.filter((id) => !GOVERNMENT_MEMBERS_MAP.has(id));

            const budgetInfo = legalAssistantGetBudgetForMinistry(resolvedAuthor.ministry);
            const loa = legalAssistantBuildLoaContext();
            const indicatorsSummary = legalAssistantBuildIndicatorsSummary();

            legalAssistantSetStatus('Consultando a IA jur√≠dica...', 'info');
            legalAssistantSetLoading(true);
            legalAssistantRenderLoadingView();

            try {
                const prompt = legalAssistantBuildPrompt({
                    author: resolvedAuthor,
                    signers,
                    manualSigners,
                    recipients: data.recipients,
                    context: data.context,
                    goal: data.goal,
                    impact: data.impact,
                    preferredInstrument: data.preferred,
                    notes: data.notes,
                    budgetInfo,
                    loa,
                    indicatorsSummary,
                    userName: userData?.name || 'Visitante',
                    userRole: userData?.role || 'Sem permiss√£o'
                });

                const aiResponse = await legalAssistantCallAI(prompt);
                LEGAL_ASSISTANT_STATE.lastRaw = aiResponse;

                let parsed = null;
                try {
                    parsed = legalAssistantParseResponse(aiResponse);
                } catch (parseError) {
                    console.warn('Assistente IA: falha ao interpretar resposta JSON', parseError);
                }

                if (parsed) {
                    LEGAL_ASSISTANT_STATE.lastResult = parsed;
                    LEGAL_ASSISTANT_STATE.lastHtml = typeof parsed.htmlDocument === 'string' ? parsed.htmlDocument.trim() : '';
                    legalAssistantDisplayResult(parsed, aiResponse);
                    legalAssistantUpdateDocActions(Boolean(LEGAL_ASSISTANT_STATE.lastHtml));
                    legalAssistantSetStatus('Minuta gerada com sucesso.', 'success');
                } else {
                    LEGAL_ASSISTANT_STATE.lastResult = null;
                    LEGAL_ASSISTANT_STATE.lastHtml = '';
                    legalAssistantDisplayFallback(aiResponse, 'N√£o foi poss√≠vel interpretar a resposta da IA. Veja o conte√∫do bruto abaixo.');
                    legalAssistantUpdateDocActions(false);
                    legalAssistantSetStatus('N√£o foi poss√≠vel interpretar a resposta da IA. Veja o conte√∫do bruto.', 'error');
                }
            } catch (error) {
                console.error('Assistente IA: erro ao consultar IA', error);
                LEGAL_ASSISTANT_STATE.lastResult = null;
                LEGAL_ASSISTANT_STATE.lastHtml = '';
                legalAssistantDisplayFallback('', error.message || 'Erro ao consultar a IA.');
                legalAssistantUpdateDocActions(false);
                legalAssistantSetStatus('Falha ao consultar a IA. Tente novamente em instantes.', 'error');
            } finally {
                legalAssistantSetLoading(false);
            }
        }

        function legalAssistantGetMember(memberId) {
            if (!memberId) return null;
            return GOVERNMENT_MEMBERS_MAP.get(memberId) || null;
        }

        function legalAssistantBuildPrompt(data) {
            const lines = [];

            lines.push('## Identifica√ß√£o do solicitante');
            lines.push(`- Usu√°rio logado: ${data.userName} (${data.userRole})`);
            if (data.author) {
                const ministryLabel = data.author.ministry ? ` - ${data.author.ministry}` : '';
                lines.push(`- Autor respons√°vel: ${data.author.displayName} (${data.author.signatureTitle || data.author.role}${ministryLabel}) | Habbo: ${data.author.habboNick}`);
            }
            lines.push(`- Destinat√°rios principais: ${data.recipients || 'n√£o informado'}`);

            lines.push('');
            lines.push('## Contexto detalhado');
            lines.push(data.context);

            lines.push('');
            lines.push('## Objetivo / resultado esperado');
            lines.push(data.goal || 'N√£o informado');

            lines.push('');
            lines.push('## Impacto or√ßament√°rio estimado');
            lines.push(data.impact || 'N√£o informado');

            lines.push('');
            lines.push('## Prefer√™ncia declarada de instrumento');
            lines.push(data.preferredInstrument || 'Sem prefer√™ncia (IA decide)');

            lines.push('');
            lines.push('## Observa√ß√µes adicionais');
            lines.push(data.notes || 'Sem observa√ß√µes adicionais.');

            lines.push('');
            lines.push('## Assinaturas previstas');
            if (Array.isArray(data.signers) && data.signers.length) {
                data.signers.forEach((signer, index) => {
                    lines.push(`${index + 1}. ${signer.displayName} - ${signer.signatureTitle || signer.role} | Habbo: ${signer.habboNick}`);
                });
            } else {
                lines.push('Nenhuma assinatura adicional al√©m do autor informado.');
            }

            if (Array.isArray(data.manualSigners) && data.manualSigners.length) {
                lines.push('');
                lines.push('## Assinaturas manuais (n√£o localizadas no cadastro oficial)');
                data.manualSigners.forEach((name) => {
                    lines.push(`- ${name}`);
                });
            }

            lines.push('');
            lines.push('## Cen√°rio or√ßament√°rio do minist√©rio do autor');
            if (data.budgetInfo) {
                const percent = data.budgetInfo.totalBudget > 0
                    ? ((data.budgetInfo.spent / data.budgetInfo.totalBudget) * 100).toFixed(2)
                    : '0.00';
                lines.push(`- Minist√©rio: ${data.budgetInfo.ministry}`);
                lines.push(`- Dota√ß√£o total: ${formatCurrency(data.budgetInfo.totalBudget)}`);
                lines.push(`- Gasto executado: ${formatCurrency(data.budgetInfo.spent)}`);
                lines.push(`- Saldo dispon√≠vel: ${formatCurrency(data.budgetInfo.available)}`);
                lines.push(`- Percentual executado: ${percent}%`);
            } else {
                lines.push('- Informa√ß√£o or√ßament√°ria n√£o encontrada para o minist√©rio do autor.');
            }

            lines.push('');
            lines.push('## Resumo fiscal (LOA e teto de gastos)');
            if (data.loa) {
                lines.push(`- Despesa executada total estimada: ${formatCurrency(data.loa.spent)}`);
                lines.push(`- Saldo estimado dentro do teto: ${formatCurrency(data.loa.remainingCeiling)}`);
                lines.push(`- Percentual estimado do teto utilizado: ${data.loa.ceilingPercent.toFixed(2)}%`);
            } else {
                lines.push('- Dados agregados indispon√≠veis.');
            }
            lines.push(`- Receita total LOA 2025: ${formatCurrency(CONFIG.LOA_DATA.totalRevenue)}`);
            lines.push(`- Despesa total planejada: ${formatCurrency(CONFIG.LOA_DATA.totalExpense)}`);
            lines.push(`- Super√°vit projetado: ${formatCurrency(CONFIG.LOA_DATA.surplus)}`);

            lines.push('');
            lines.push('## Indicadores econ√¥micos recentes');
            lines.push(data.indicatorsSummary || 'Indicadores indispon√≠veis no momento.');

            lines.push('');
            lines.push('## Instru√ß√µes do usu√°rio');
            lines.push('- Validar compet√™ncias constitucionais, hierarquia normativa e rito adequado.');
            lines.push('- Apontar riscos jur√≠dicos, or√ßament√°rios ou procedimentais.');
            lines.push('- Estruturar a minuta solicitada em formato oficial brasileiro.');

            return lines.join('\n');
        }

        function legalAssistantGetBudgetForMinistry(ministryName) {
            if (!ministryName || !Array.isArray(budgetData)) return null;
            const normalized = ministryName.toLowerCase();
            return budgetData.find((item) => (item.ministry || '').toLowerCase() === normalized) || null;
        }

        function legalAssistantBuildLoaContext() {
            if (!Array.isArray(budgetData) || !budgetData.length) {
                return {
                    spent: 0,
                    totalBudget: 0,
                    remainingCeiling: CONFIG.SPENDING_CEILING,
                    ceilingPercent: 0
                };
            }
            const totalSpent = budgetData.reduce((sum, entry) => sum + Number(entry.spent || 0), 0);
            const totalBudget = budgetData.reduce((sum, entry) => sum + Number(entry.totalBudget || 0), 0);
            const remainingCeiling = CONFIG.SPENDING_CEILING - totalSpent;
            const ceilingPercent = CONFIG.SPENDING_CEILING > 0 ? (totalSpent / CONFIG.SPENDING_CEILING) * 100 : 0;
            return {
                spent: totalSpent,
                totalBudget,
                remainingCeiling,
                ceilingPercent
            };
        }

        function legalAssistantBuildIndicatorsSummary() {
            if (!indicatorsData || !indicatorsData.indicators) {
                return 'Indicadores indispon√≠veis no momento.';
            }

            const entries = Object.entries(indicatorsData.indicators)
                .filter(([, value]) => value && value.label)
                .slice(0, 8);

            if (!entries.length) {
                return 'Indicadores indispon√≠veis no momento.';
            }

            return entries.map(([, value]) => {
                const formattedValue = typeof value.formatted === 'string'
                    ? value.formatted
                    : typeof value.value === 'number'
                        ? value.value.toLocaleString('pt-BR', { maximumFractionDigits: 2 })
                        : String(value.value ?? '');
                const change = typeof value.changePercent === 'number'
                    ? `${value.changePercent >= 0 ? '+' : ''}${value.changePercent.toFixed(2)}%`
                    : 'varia√ß√£o n√£o informada';
                return `- ${value.label}: ${formattedValue} | Varia√ß√£o: ${change}`;
            }).join('\n');
        }

        async function legalAssistantCallAI(userPrompt) {
            const response = await fetch(AI_CONFIG.PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: AI_CONFIG.MODEL,
                    messages: [
                        { role: 'system', content: LEGAL_ASSISTANT_SYSTEM_PROMPT },
                        { role: 'system', content: LEGAL_CONTEXT },
                        { role: 'user', content: userPrompt }
                    ],
                    temperature: AI_CONFIG.TEMPERATURE,
                    max_tokens: AI_CONFIG.MAX_TOKENS
                })
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API retornou ${response.status}: ${errorBody}`);
            }

            const data = await response.json();
            const content = data?.choices?.[0]?.message?.content;
            if (!content) {
                throw new Error('Resposta da IA vazia.');
            }
            return content;
        }

        function legalAssistantExtractJsonPayload(rawText) {
            const start = rawText.indexOf('{');
            const end = rawText.lastIndexOf('}');
            if (start === -1 || end === -1 || end <= start) {
                throw new Error('N√£o foi poss√≠vel localizar um objeto JSON na resposta da IA.');
            }
            return rawText.slice(start, end + 1);
        }

        function legalAssistantRepairJsonString(jsonString) {
            let result = '';
            let inString = false;
            let escaped = false;

            for (let i = 0; i < jsonString.length; i++) {
                const char = jsonString[i];

                if (inString) {
                    if (escaped) {
                        escaped = false;
                        result += char;
                        continue;
                    }

                    if (char === '\\') {
                        escaped = true;
                        result += char;
                        continue;
                    }

                    if (char === '"') {
                        inString = false;
                        result += char;
                        continue;
                    }

                    if (char === '\r') {
                        if (jsonString[i + 1] === '\n') {
                            i += 1;
                        }
                        result += '\\n';
                        continue;
                    }

                    if (char === '\n') {
                        result += '\\n';
                        continue;
                    }

                    if (char === '\t') {
                        result += '\\t';
                        continue;
                    }

                    if (char === '\f') {
                        result += '\\f';
                        continue;
                    }

                    if (char === '\b') {
                        result += '\\b';
                        continue;
                    }

                    if (char === '\u2028') {
                        result += '\\u2028';
                        continue;
                    }

                    if (char === '\u2029') {
                        result += '\\u2029';
                        continue;
                    }

                    result += char;
                    continue;
                }

                result += char;

                if (char === '"') {
                    let backslashCount = 0;
                    for (let j = i - 1; j >= 0 && jsonString[j] === '\\'; j--) {
                        backslashCount += 1;
                    }
                    if (backslashCount % 2 === 0) {
                        inString = true;
                        escaped = false;
                    }
                }
            }

            return result;
        }

        function legalAssistantParseResponse(text) {
            if (!text) throw new Error('Resposta vazia.');

            let trimmed = text.trim();
            if (trimmed.startsWith('```')) {
                trimmed = trimmed.replace(/^```json/i, '')
                    .replace(/^```/, '')
                    .replace(/```$/, '')
                    .trim();
            }

            const payload = legalAssistantExtractJsonPayload(trimmed);

            try {
                return JSON.parse(payload);
            } catch (initialError) {
                const repaired = legalAssistantRepairJsonString(payload);
                if (repaired !== payload) {
                    console.warn('Assistente IA: resposta com formata√ß√£o irregular, aplicando reparo autom√°tico.', initialError);
                    return JSON.parse(repaired);
                }
                throw initialError;
            }
        }

        function legalAssistantDisplayResult(result, rawText) {
            const container = document.getElementById('legalAssistantResult');
            const rawContainer = document.getElementById('legalAssistantRaw');
            const previewWrapper = document.getElementById('legalAssistantPreviewWrapper');
            const previewFrame = document.getElementById('legalAssistantPreview');

            if (!container) return;

            const recommended = result?.recommendedInstrument || {};
            const constitutional = result?.constitutionalAnalysis || {};
            const budget = result?.budgetAssessment || {};
            const draft = result?.draft || {};
            const nextSteps = Array.isArray(result?.nextSteps) ? result.nextSteps : [];
            const htmlDocument = typeof result?.htmlDocument === 'string' ? result.htmlDocument.trim() : '';

            const alternatives = Array.isArray(recommended.alternatives) ? recommended.alternatives : [];

            const statusClass = (constitutional.status || '').toLowerCase();
            let statusBadge = '';
            if (constitutional.status) {
                const label = constitutional.status.replace(/_/g, ' ').toUpperCase();
                const badgeColor = statusBadgeColor(statusClass);
                statusBadge = `<span class="legal-assistant-chip" style="background:${badgeColor.background};color:${badgeColor.color};">${sanitizeHtml(label)}</span>`;
            }

            const summaryHtml = `
                <div class="legal-assistant-section">
                    <h5>Resumo da Recomenda√ß√£o</h5>
                    <p>${sanitizeHtml(recommended.summary || 'Sem resumo fornecido.')}</p>
                    <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        <span class="legal-assistant-chip">Instrumento recomendado: <strong>${sanitizeHtml(recommended.type || 'N√£o definido')}</strong></span>
                        ${recommended.confidence ? `<span class="legal-assistant-chip">Confian√ßa: ${sanitizeHtml(recommended.confidence)}</span>` : ''}
                        ${alternatives.length ? `<span class="legal-assistant-chip">Alternativas: ${sanitizeHtml(alternatives.join(', '))}</span>` : ''}
                    </div>
                </div>
            `;

            const constitutionalHtml = `
                <div class="legal-assistant-section">
                    <h5>An√°lise Constitucional</h5>
                    ${statusBadge || ''}
                    <p style="margin-top: 0.75rem;">${sanitizeHtml(constitutional.explanation || 'Sem an√°lise detalhada informada.')}</p>
                    ${renderAssistantListSection('Refer√™ncias', constitutional.references)}
                    ${renderAssistantListSection('Alertas', constitutional.alerts)}
                </div>
            `;

            const budgetHtml = `
                <div class="legal-assistant-section">
                    <h5>Avalia√ß√£o Or√ßament√°ria</h5>
                    <p>${sanitizeHtml(budget.impactSummary || 'Sem avalia√ß√£o informada.')}</p>
                    <div class="legal-assistant-list" style="margin-top: 0.75rem;">
                        <div><strong>Compatibilidade com o teto:</strong> ${sanitizeHtml(budget.ceilingCompatibility || 'n√£o informado')}</div>
                    </div>
                    ${renderAssistantListSection('Observa√ß√µes', budget.observations)}
                </div>
            `;

            const draftHtml = renderAssistantDraftSection(draft);
            const nextStepsHtml = renderAssistantListSection('Pr√≥ximos passos sugeridos', nextSteps);

            container.innerHTML = [summaryHtml, constitutionalHtml, budgetHtml, draftHtml, nextStepsHtml].join('');

            if (htmlDocument && previewWrapper && previewFrame) {
                previewFrame.srcdoc = htmlDocument;
                previewWrapper.style.display = 'block';
            } else if (previewWrapper && previewFrame) {
                previewFrame.srcdoc = '';
                previewWrapper.style.display = 'none';
            }

            if (rawContainer) {
                rawContainer.style.display = 'none';
                rawContainer.textContent = '';
            }
        }

        function statusBadgeColor(status) {
            switch (status) {
                case 'constitucional':
                case 'sem_risco':
                    return { background: 'rgba(76, 175, 80, 0.2)', color: '#2e7d32' };
                case 'condicionado':
                case 'risco':
                case 'aten√ß√£o':
                    return { background: 'rgba(255, 152, 0, 0.2)', color: '#ef6c00' };
                case 'inviavel':
                case 'inconstitucional':
                    return { background: 'rgba(244, 67, 54, 0.2)', color: '#c62828' };
                default:
                    return { background: 'rgba(102, 126, 234, 0.15)', color: '#1a237e' };
            }
        }

        function renderAssistantListSection(title, items) {
            if (!items || (Array.isArray(items) && !items.length)) {
                return '';
            }
            const values = Array.isArray(items) ? items : [items];
            const listItems = values
                .filter((item) => item !== null && item !== undefined && String(item).trim() !== '')
                .map((item) => `<li>${sanitizeHtml(String(item))}</li>`);
            if (!listItems.length) return '';
            return `
                <div style="margin-top: 0.75rem;">
                    <strong>${sanitizeHtml(title)}:</strong>
                    <ul class="legal-assistant-list">
                        ${listItems.join('')}
                    </ul>
                </div>
            `;
        }

        function renderAssistantDraftSection(draft) {
            if (!draft || (!draft.title && !draft.ementa && (!Array.isArray(draft.articles) || !draft.articles.length))) {
                return `
                    <div class="legal-assistant-section">
                        <h5>Minuta do Ato</h5>
                        <p>Sem minuta gerada.</p>
                    </div>
                `;
            }

            const considerandos = renderAssistantListSection('Considerandos', draft.considerandos);
            const articles = renderAssistantArticles(draft.articles);
            const signatures = renderAssistantSignatures(draft.signatures);

            return `
                <div class="legal-assistant-section">
                    <h5>Minuta do Ato</h5>
                    ${draft.title ? `<p><strong>T√≠tulo:</strong> ${sanitizeHtml(draft.title)}</p>` : ''}
                    ${draft.ementa ? `<p><strong>Ementa:</strong> ${sanitizeHtml(draft.ementa)}</p>` : ''}
                    ${considerandos}
                    ${articles}
                    ${draft.finalDisposition ? `<p><strong>Disposi√ß√£o final:</strong> ${sanitizeHtml(draft.finalDisposition)}</p>` : ''}
                    ${signatures}
                </div>
            `;
        }

        function renderAssistantArticles(articles) {
            if (!Array.isArray(articles) || !articles.length) return '';
            const items = articles.map((article) => {
                const number = article?.number !== undefined ? article.number : '?';
                const text = article?.text || '';
                return `<li><strong>Art. ${sanitizeHtml(String(number))}¬∫ -</strong> ${sanitizeHtml(text)}</li>`;
            });
            return `
                <div style="margin-top: 0.75rem;">
                    <strong>Artigos:</strong>
                    <ol class="legal-assistant-list">
                        ${items.join('')}
                    </ol>
                </div>
            `;
        }

        function renderAssistantSignatures(signatures) {
            if (!Array.isArray(signatures) || !signatures.length) return '';
            const items = signatures.map((signature) => {
                const name = signature?.name || signature?.displayName || '';
                const role = signature?.role || signature?.signatureTitle || '';
                const nick = signature?.habboNick || '';
                return `<li><strong>${sanitizeHtml(name)}</strong> - ${sanitizeHtml(role)} (Habbo: ${sanitizeHtml(nick)})</li>`;
            });
            return `
                <div style="margin-top: 0.75rem;">
                    <strong>Assinaturas:</strong>
                    <ul class="legal-assistant-list">
                        ${items.join('')}
                    </ul>
                </div>
            `;
        }

        function legalAssistantDisplayFallback(rawText, errorMessage) {
            const container = document.getElementById('legalAssistantResult');
            const rawContainer = document.getElementById('legalAssistantRaw');
            const previewWrapper = document.getElementById('legalAssistantPreviewWrapper');
            const previewFrame = document.getElementById('legalAssistantPreview');

            if (container) {
                container.innerHTML = `
                    <div class="legal-assistant-error">
                        ${sanitizeHtml(errorMessage || 'N√£o foi poss√≠vel interpretar a resposta da IA.')}
                    </div>
                `;
            }

            if (rawContainer) {
                if (rawText) {
                    rawContainer.style.display = 'block';
                    rawContainer.textContent = rawText;
                } else {
                    rawContainer.style.display = 'none';
                    rawContainer.textContent = '';
                }
            }

            if (previewWrapper && previewFrame) {
                previewFrame.srcdoc = '';
                previewWrapper.style.display = 'none';
            }
        }

        function resetLegalAssistantForm() {
            if (LEGAL_ASSISTANT_STATE.isGenerating) return;
            const form = document.getElementById('legalAssistantForm');
            if (form) {
                form.reset();
            }
            legalAssistantGetSignerCheckboxes().forEach((checkbox) => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
            if (userData && userData.name && GOVERNMENT_MEMBERS_MAP.has(userData.name)) {
                const authorSelect = document.getElementById('legalAssistantAuthor');
                if (authorSelect) {
                    authorSelect.value = userData.name;
                }
                legalAssistantEnsureSigner(userData.name);
            } else {
                const authorSelect = document.getElementById('legalAssistantAuthor');
                if (authorSelect) {
                    authorSelect.value = '';
                }
            }
            legalAssistantRenderPlaceholder();
            legalAssistantSetStatus('Formul√°rio limpo. Preencha os dados para gerar uma nova minuta.', 'info');
        }

        function openLegalAssistant() {
            const modal = document.getElementById('legalAssistantModal');
            if (!modal) return;

            if (!legalAssistantInitialized) {
                legalAssistantInitialize();
            }

            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';

            const contextField = document.getElementById('legalAssistantContext');
            if (contextField) {
                setTimeout(() => contextField.focus(), 150);
            }
        }

        function closeLegalAssistant() {
            if (LEGAL_ASSISTANT_STATE.isGenerating) return;
            const modal = document.getElementById('legalAssistantModal');
            if (!modal) return;
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }

        function downloadLegalAssistantDocument() {
            if (!LEGAL_ASSISTANT_STATE.lastHtml) {
                legalAssistantSetStatus('Gere uma minuta antes de baixar o HTML.', 'error');
                return;
            }
            try {
                const blob = new Blob([LEGAL_ASSISTANT_STATE.lastHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `minuta-oficial-${Date.now()}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                legalAssistantSetStatus('Arquivo HTML baixado com sucesso.', 'success');
            } catch (error) {
                console.error('Assistente IA: erro ao baixar HTML', error);
                legalAssistantSetStatus('N√£o foi poss√≠vel baixar o HTML.', 'error');
            }
        }

        function openLegalAssistantDocument() {
            if (!LEGAL_ASSISTANT_STATE.lastHtml) {
                legalAssistantSetStatus('Gere uma minuta antes de abrir o HTML.', 'error');
                return;
            }
            const blob = new Blob([LEGAL_ASSISTANT_STATE.lastHtml], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank', 'noopener');
            setTimeout(() => URL.revokeObjectURL(url), 60000);
        }

        async function copyLegalAssistantHtml() {
            if (!LEGAL_ASSISTANT_STATE.lastHtml) {
                legalAssistantSetStatus('Gere uma minuta antes de copiar o HTML.', 'error');
                return;
            }
            try {
                await navigator.clipboard.writeText(LEGAL_ASSISTANT_STATE.lastHtml);
                legalAssistantSetStatus('HTML copiado para a √°rea de transfer√™ncia.', 'success');
            } catch (error) {
                console.error('Assistente IA: erro ao copiar HTML', error);
                legalAssistantSetStatus('N√£o foi poss√≠vel copiar o HTML. Verifique as permiss√µes do navegador.', 'error');
            }
        }

    function loadProposalsRealtime() {
            const q = query(
                collection(db, 'proposals'),
                where('status', '==', 'approved'),
                orderBy('approvedAt', 'desc')
            );
            
            unsubscribeProposals = onSnapshot(q, (snapshot) => {
                proposalsData = [];
                snapshot.forEach((doc) => {
                    proposalsData.push({ id: doc.id, ...doc.data() });
                });
                
                loadApprovedProposals();
            }, (error) => {
                console.error('Erro ao carregar propostas:', error);
            });
        }

    function loadNotificationsRealtime() {
        if (!notificationRecipientTags.length) {
            console.warn('Sem destinat√°rios configurados para notifica√ß√µes');
            return;
        }

        if (unsubscribeNotifications) {
            unsubscribeNotifications();
        }

        const notificationsQuery = query(
            collection(db, 'notifications'),
            where('targetUsers', 'array-contains-any', notificationRecipientTags),
            orderBy('createdAt', 'desc')
        );
        
        unsubscribeNotifications = onSnapshot(notificationsQuery, (snapshot) => {
            notificationsData = [];
            let unreadCount = 0;
            
            snapshot.forEach((docSnap) => {
                if (docSnap.id === '_init') return;
                const notification = { id: docSnap.id, ...docSnap.data() };
                const isRead = hasUserReadNotification(notification);
                notification._isRead = isRead;
                notificationsData.push(notification);
                if (!isRead) unreadCount++;
            });
            
            updateNotificationBadge(unreadCount);
            displayNotifications();
        }, (error) => {
            console.error('Erro ao carregar notifica√ß√µes:', error);
        });
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return; // Verificar se elemento existe
            
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

    function displayNotifications() {
        const container = document.getElementById('notificationsList');
        if (!container) return;
        
        if (notificationsData.length === 0) {
            container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #999;">Nenhuma notifica√ß√£o</div>';
            return;
        }

        container.innerHTML = notificationsData.map((notif) => {
            const severity = getNotificationSeverity(notif.type);
            const classes = ['notification-item'];
            if (severity) classes.push(severity);
            if (!notif._isRead) classes.push('unread');

            const actionLabel = getNotificationActionLabel(notif);

            return `
                <button type="button" class="${classes.join(' ')}" data-id="${notif.id}">
                    <div class="notification-icon">${getNotificationIcon(notif.type)}</div>
                    <div class="notification-content">
                        <div class="notification-title">${sanitizeHtml(notif.title || 'Notifica√ß√£o')}</div>
                        <div class="notification-message">${buildNotificationMessage(notif)}</div>
                        <div class="notification-time">${formatTimeAgo(notif.createdAt)}</div>
                        ${actionLabel ? `<div class="notification-action">${actionLabel}</div>` : ''}
                    </div>
                </button>
            `;
        }).join('');

        container.querySelectorAll('.notification-item').forEach((item) => {
            item.addEventListener('click', async () => {
                const notificationId = item.dataset.id;
                const notification = notificationsData.find((n) => n.id === notificationId);
                if (!notification) return;

                await markNotificationAsRead(notificationId);
                item.classList.remove('unread');
                notification._isRead = true;
                updateNotificationBadge(notificationsData.filter((n) => !n._isRead).length);
                handleNotificationClick(notification);
            });
        });
    }

    async function markAllNotificationsAsRead() {
        const key = getReadTrackingKey();
        if (!key) return;

        const unreadNotifications = notificationsData.filter((notif) => !notif._isRead);
        if (unreadNotifications.length === 0) {
            updateNotificationBadge(0);
            return;
        }

        try {
            const batch = writeBatch(db);
            unreadNotifications.forEach((notif) => {
                const notifRef = doc(db, 'notifications', notif.id);
                batch.update(notifRef, {
                    readBy: arrayUnion(key)
                });
                notif._isRead = true;
            });

            await batch.commit();
            updateNotificationBadge(0);
            displayNotifications();
        } catch (error) {
            console.error('Erro ao marcar notifica√ß√µes como lidas:', error);
        }
    }

    async function markNotificationAsRead(notificationId) {
        const key = getReadTrackingKey();
        if (!key) return;

        const notification = notificationsData.find((notif) => notif.id === notificationId);
        if (!notification || notification._isRead) return;

        try {
            const notifRef = doc(db, 'notifications', notificationId);
            await updateDoc(notifRef, {
                readBy: arrayUnion(key)
            });
            notification._isRead = true;
        } catch (error) {
            console.error('Erro ao marcar notifica√ß√£o como lida:', error);
        }
    }

    function handleNotificationClick(notification) {
        switch (notification.type) {
            case 'proposal_submitted':
                openProposalForReview(notification);
                break;
            case 'proposal_needs_adjustment':
                if (notification.status === 'resubmitted') {
                    openNotificationInfoModal({
                        title: 'Ajustes j√° enviados',
                        body: 'Esta proposta j√° foi reenviada e aguarda uma nova an√°lise da Presid√™ncia.',
                        accent: 'success'
                    });
                } else {
                    openProposalAdjustmentWorkflow(notification);
                }
                break;
            case 'proposal_rejected':
                showProposalRejectionDetails(notification);
                break;
            case 'proposal_approved':
                highlightApprovedProposalsSection(notification);
                break;
            case 'proposal_resubmitted':
                openProposalForReview(notification);
                break;
            default:
                break;
        }
    }

    function openProposalForReview(notification) {
        const leadershipRoles = ['Presidenta', 'Vice-Presidente'];
        if (!leadershipRoles.includes(userData.role)) return;

        const targetUrl = notification.proposalId
            ? `admin.html?proposalId=${encodeURIComponent(notification.proposalId)}&source=notification`
            : 'admin.html';
        window.location.href = targetUrl;
    }

    async function openProposalAdjustmentWorkflow(notification) {
        if (!notification.proposalId) {
            openNotificationInfoModal({
                title: 'N√£o foi poss√≠vel abrir os ajustes',
                body: 'O identificador da proposta est√° ausente nesta notifica√ß√£o.',
                accent: 'error'
            });
            return;
        }

        openNotificationInfoModal({
            title: 'Carregando proposta',
            body: 'Aguarde um instante enquanto resgatamos os dados para ajuste...'
        });

        try {
            const proposalRef = doc(db, 'proposals', notification.proposalId);
            const proposalSnap = await getDoc(proposalRef);

            closeNotificationModal();

            if (!proposalSnap.exists()) {
                openNotificationInfoModal({
                    title: 'Proposta n√£o encontrada',
                    body: 'N√£o localizamos a proposta vinculada a esta notifica√ß√£o. Ela pode ter sido removida.',
                    accent: 'error'
                });
                return;
            }

            const proposal = { id: proposalSnap.id, ...proposalSnap.data() };
            adjustmentState = {
                notification,
                proposal,
                isSubmitting: false
            };

            populateAdjustmentModal(proposal, notification);

            const modal = document.getElementById('adjustmentModal');
            if (modal) {
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
            }
        } catch (error) {
            console.error('Erro ao carregar proposta para ajustes:', error);
            closeNotificationModal();
            openNotificationInfoModal({
                title: 'Erro ao carregar proposta',
                body: sanitizeHtml(error.message || 'Tente novamente daqui a pouco.'),
                accent: 'error'
            });
        }
    }

    function showProposalRejectionDetails(notification) {
        const lines = [
            notification.message ? sanitizeHtml(notification.message) : '',
            notification.feedback ? `<strong>Motivo:</strong> ${sanitizeHtml(notification.feedback)}` : '',
            notification.senderName ? `<strong>Avaliador(a):</strong> ${sanitizeHtml(notification.senderName)}` : ''
        ].filter(Boolean);

        openNotificationInfoModal({
            title: 'Proposta Rejeitada',
            body: lines.join('<br><br>'),
            accent: 'error'
        });
    }

    function highlightApprovedProposalsSection() {
        const section = document.getElementById('proposalsTracking');
        if (!section) return;

        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        section.classList.add('highlighted');
        setTimeout(() => section.classList.remove('highlighted'), 2000);
    }

    function openNotificationInfoModal({ title, body, accent = 'info', actions = [] }) {
        const modal = document.getElementById('notificationModal');
        if (!modal) return;

        const content = modal.querySelector('.modal-content');
        const titleEl = document.getElementById('notificationModalTitle');
        const bodyEl = document.getElementById('notificationModalBody');
        const actionsEl = document.getElementById('notificationModalActions');

        ['accent-success', 'accent-warning', 'accent-error'].forEach(cls => content.classList.remove(cls));
        if (accent === 'success') content.classList.add('accent-success');
        if (accent === 'warning') content.classList.add('accent-warning');
        if (accent === 'error') content.classList.add('accent-error');

        titleEl.textContent = title || 'Notifica√ß√£o';
        bodyEl.innerHTML = body || '';

        actionsEl.innerHTML = '';
        if (actions && actions.length > 0) {
            actionsEl.style.display = 'flex';
            actionsEl.style.gap = '0.75rem';
            actions.forEach((action) => {
                const button = document.createElement('button');
                button.className = `btn btn-modal ${action.variant === 'secondary' ? '' : 'btn-approve'}`;
                if (action.variant === 'secondary') {
                    button.style.background = '#e0e0e0';
                    button.style.color = '#333';
                }
                button.textContent = action.label;
                button.addEventListener('click', () => {
                    if (typeof action.handler === 'function') {
                        action.handler();
                    }
                });
                actionsEl.appendChild(button);
            });
        } else {
            actionsEl.style.display = 'none';
        }

        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
    }

    function closeNotificationModal() {
        const modal = document.getElementById('notificationModal');
        if (!modal) return;
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
    }

    function populateAdjustmentModal(proposal, notification) {
        const titleEl = document.getElementById('adjustmentProposalTitle');
        const ministryEl = document.getElementById('adjustmentProposalMinistry');
        const ownerEl = document.getElementById('adjustmentProposalOwner');
        const costEl = document.getElementById('adjustmentProposalCost');
        const summaryInput = document.getElementById('adjustSummaryInput');
        const costInput = document.getElementById('adjustCostInput');
        const justificationInput = document.getElementById('adjustJustificationInput');
        const bodyInput = document.getElementById('adjustBodyInput');
        const feedbackEl = document.getElementById('adjustmentFeedbackMessage');
        const submitButton = document.getElementById('adjustmentSubmitButton');

        const docLabel = proposal.documentType || notification.documentType || 'Documento';
        const summary = proposal.summary || notification.summary || '';

        if (titleEl) {
            titleEl.textContent = summary ? `${docLabel}: ${summary}` : docLabel;
        }
        if (ministryEl) {
            ministryEl.textContent = proposal.ministry || 'N√£o informado';
        }
        if (ownerEl) {
            ownerEl.textContent = proposal.requestorName || userData.name || 'Desconhecido';
        }
        if (costEl) {
            costEl.textContent = formatCurrency(Number(proposal.estimatedCost || notification.estimatedCost || 0));
        }
        if (summaryInput) {
            summaryInput.value = summary;
        }
        if (costInput) {
            const numericValue = Number(proposal.estimatedCost || notification.estimatedCost || 0);
            costInput.value = numericValue.toFixed(2);
        }
        if (justificationInput) {
            justificationInput.value = proposal.justification || '';
        }
        if (bodyInput) {
            bodyInput.value = proposal.body || '';
        }
        if (feedbackEl) {
            if (notification.feedback) {
                feedbackEl.innerHTML = sanitizeHtml(notification.feedback);
                feedbackEl.style.display = 'block';
            } else {
                feedbackEl.innerHTML = '';
                feedbackEl.style.display = 'none';
            }
        }
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'üîÅ Reenviar Proposta';
        }

        setAdjustmentError();
    }

    function closeAdjustmentModal() {
        const modal = document.getElementById('adjustmentModal');
        if (modal) {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
        }
        adjustmentState = {
            notification: null,
            proposal: null,
            isSubmitting: false
        };
        setAdjustmentError();
    }

    function setAdjustmentError(message = '') {
        const errorEl = document.getElementById('adjustmentErrorMessage');
        if (!errorEl) return;
        if (message) {
            errorEl.innerHTML = message;
            errorEl.style.display = 'block';
        } else {
            errorEl.innerHTML = '';
            errorEl.style.display = 'none';
        }
    }

    async function submitProposalAdjustment() {
        if (!adjustmentState.proposal || adjustmentState.isSubmitting) return;

        const summary = document.getElementById('adjustSummaryInput')?.value.trim() || '';
        const costValue = document.getElementById('adjustCostInput')?.value || '0';
        const justification = document.getElementById('adjustJustificationInput')?.value.trim() || '';
        const body = document.getElementById('adjustBodyInput')?.value.trim() || '';
        const submitButton = document.getElementById('adjustmentSubmitButton');

        if (!summary || !justification || !body) {
            setAdjustmentError('Preencha todos os campos obrigat√≥rios antes de reenviar.');
            return;
        }

        const estimatedCost = Number(costValue);
        if (Number.isNaN(estimatedCost) || estimatedCost < 0) {
            setAdjustmentError('Informe um valor v√°lido para o custo estimado.');
            return;
        }

        setAdjustmentError();
        adjustmentState.isSubmitting = true;
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = 'Enviando ajustes...';
        }

        try {
            const proposalRef = doc(db, 'proposals', adjustmentState.proposal.id);

            await updateDoc(proposalRef, {
                summary,
                estimatedCost,
                justification,
                body,
                status: 'pending',
                feedback: null,
                approvedAt: null,
                rejectedAt: null,
                adjustmentRespondedAt: serverTimestamp(),
                adjustmentRespondedBy: userData.name,
                updatedAt: serverTimestamp()
            });

            await addDoc(collection(db, 'notifications'), {
                type: 'proposal_resubmitted',
                title: 'üîÅ Proposta Reenviada',
                message: `${userData.name} reenviou "${summary}" ap√≥s ajustes.`,
                proposalId: adjustmentState.proposal.id,
                summary,
                ministry: adjustmentState.proposal.ministry || null,
                status: 'resubmitted',
                estimatedCost,
                targetUsers: Array.from(new Set([
                    'all',
                    'Presidenta',
                    'Vice-Presidente',
                    'role:Presidenta',
                    'role:Vice-Presidente',
                    'Chocotone',
                    'Bryan dos Ouros',
                    'name:Chocotone',
                    'name:Bryan dos Ouros'
                ])),
                senderName: userData.name,
                senderRole: userData.role,
                readBy: [],
                createdAt: serverTimestamp()
            });

            if (adjustmentState.notification?.id) {
                try {
                    await updateDoc(doc(db, 'notifications', adjustmentState.notification.id), {
                        status: 'resubmitted',
                        resolvedAt: serverTimestamp(),
                        readBy: arrayUnion(getReadTrackingKey())
                    });
                } catch (innerError) {
                    console.warn('N√£o foi poss√≠vel atualizar notifica√ß√£o original:', innerError);
                }

                const localNotif = notificationsData.find((notif) => notif.id === adjustmentState.notification.id);
                if (localNotif) {
                    localNotif.status = 'resubmitted';
                    localNotif._isRead = true;
                    localNotif.message = 'Proposta reenviada. Aguardando nova an√°lise.';
                }
            }

            closeAdjustmentModal();
            updateNotificationBadge(notificationsData.filter((n) => !n._isRead).length);
            displayNotifications();

            openNotificationInfoModal({
                title: 'Proposta reenviada com sucesso',
                body: 'A proposta foi reenviada e j√° est√° novamente na fila da Presid√™ncia.',
                accent: 'success'
            });
        } catch (error) {
            console.error('Erro ao reenviar proposta ajustada:', error);
            setAdjustmentError('Erro ao reenviar proposta: ' + sanitizeHtml(error.message || 'Tente novamente.'));

            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = 'üîÅ Reenviar Proposta';
            }

            adjustmentState.isSubmitting = false;
            return;
        }

        adjustmentState.isSubmitting = false;
    }

    function getNotificationIcon(type) {
            const icons = {
                'proposal_submitted': 'üìù',
                'proposal_approved': '‚úÖ',
                'proposal_rejected': '‚ùå',
                'proposal_needs_adjustment': '‚úèÔ∏è',
                'proposal_resubmitted': 'üîÅ',
                'budget_updated': 'üí∞',
                'system_update': 'üîî'
            };
            return icons[type] || 'üì¢';
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(value);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Data n√£o dispon√≠vel';
            
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleString('pt-BR');
            }
            
            if (typeof timestamp === 'string') {
                return new Date(timestamp).toLocaleString('pt-BR');
            }
            
            return 'Data inv√°lida';
        }

        function loadBudgetData() {
            if (budgetData.length === 0) return;
            
            const totalSpent = budgetData.reduce((sum, m) => sum + Number(m.spent || 0), 0);
            const totalAvailable = budgetData.reduce((sum, m) => {
                const available = Number(m.totalBudget || 0) - Number(m.spent || 0);
                return sum + Math.max(available, 0);
            }, 0);
            
            const ceilingUsedPercent = CONFIG.SPENDING_CEILING > 0
                ? (totalSpent / CONFIG.SPENDING_CEILING) * 100
                : 0;
            const remainingCeiling = CONFIG.SPENDING_CEILING - totalSpent;
            
            // Atualizar cards principais
            document.getElementById('totalBudget').textContent = formatCurrency(totalAvailable);
            document.getElementById('totalRevenue').textContent = formatCurrency(CONFIG.LOA_DATA.totalRevenue).replace(',00', '');
            document.getElementById('totalExpense').textContent = formatCurrency(totalSpent).replace(',00', '');
            document.getElementById('surplus').textContent = formatCurrency(CONFIG.LOA_DATA.totalRevenue - totalSpent).replace(',00', '');
            
            // Atualizar teto de gastos
            const ceilingElement = document.getElementById('ceilingPercentage');
            const spendingCeilingEl = document.getElementById('spendingCeiling');
            if (spendingCeilingEl) {
                spendingCeilingEl.textContent = formatCurrency(Math.max(remainingCeiling, 0));
            }
            if (ceilingElement) {
                ceilingElement.textContent = `${ceilingUsedPercent.toFixed(2)}%`;
                if (ceilingUsedPercent >= 100) {
                    ceilingElement.style.color = '#f44336';
                    ceilingElement.style.fontWeight = '800';
                } else if (ceilingUsedPercent >= 90) {
                    ceilingElement.style.color = '#ff9800';
                    ceilingElement.style.fontWeight = '700';
                } else {
                    ceilingElement.style.color = '#4caf50';
                    ceilingElement.style.fontWeight = '700';
                }
            }
            
            // Atualizar barra de progresso
            const expenseProgressBar = document.getElementById('expenseProgress');
            if (expenseProgressBar) {
                expenseProgressBar.style.width = `${Math.min(ceilingUsedPercent, 100)}%`;
                if (ceilingUsedPercent >= 100) {
                    expenseProgressBar.style.background = 'linear-gradient(90deg, #f44336, #c62828)';
                    document.getElementById('totalExpense').style.color = '#f44336';
                } else if (ceilingUsedPercent >= 90) {
                    expenseProgressBar.style.background = 'linear-gradient(90deg, #ff9800, #f57c00)';
                    document.getElementById('totalExpense').style.color = '#ff9800';
                } else if (ceilingUsedPercent >= 75) {
                    expenseProgressBar.style.background = 'linear-gradient(90deg, #ffc107, #ff9800)';
                    document.getElementById('totalExpense').style.color = 'inherit';
                } else {
                    expenseProgressBar.style.background = 'var(--bg-gradient)';
                    document.getElementById('totalExpense').style.color = 'inherit';
                }
            }
            
            const now = new Date();
            document.getElementById('currentDate').textContent = `Atualizado em: ${now.toLocaleString('pt-BR')}`;
            
            if (ceilingUsedPercent >= 95) {
                showCeilingWarning(ceilingUsedPercent, totalSpent);
            }
        }
        
        function showCeilingWarning(percentage, totalExpense) {
            const warningDiv = document.getElementById('ceilingWarning');
            if (!warningDiv) {
                const warning = document.createElement('div');
                warning.id = 'ceilingWarning';
                warning.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: ${percentage >= 100 ? '#f44336' : '#ff9800'};
                    color: white;
                    padding: 1.5rem;
                    border-radius: 15px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    z-index: 9999;
                    max-width: 400px;
                    animation: slideInRight 0.5s ease;
                    font-weight: 600;
                `;
                
                const message = percentage >= 100 
                    ? `üö® ATEN√á√ÉO: Teto de gastos ULTRAPASSADO! ${percentage.toFixed(1)}% do limite`
                    : `‚ö†Ô∏è ALERTA: Aproximando do teto de gastos! ${percentage.toFixed(1)}% do limite`;
                
                warning.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">${message}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">
                                Gastou: ${formatCurrency(totalExpense)}<br>
                                Teto: ${formatCurrency(CONFIG.SPENDING_CEILING)}
                            </div>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: rgba(255,255,255,0.3);
                            border: none;
                            color: white;
                            font-size: 1.5rem;
                            cursor: pointer;
                            border-radius: 50%;
                            width: 30px;
                            height: 30px;
                            margin-left: 10px;
                        ">√ó</button>
                    </div>
                `;
                
                document.body.appendChild(warning);
            }
        }

        function loadMinistryTable() {
            const tbody = document.getElementById('ministryTableBody');
            
            if (budgetData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">Carregando or√ßamentos...</td></tr>';
                return;
            }
            
            // Limpar a tabela antes de reconstruir
            const rows = [];
            
            budgetData.forEach((ministry) => {
                const totalBudget = Number(ministry.totalBudget || 0);
                const spent = Number(ministry.spent || 0);
                const available = totalBudget - spent;
                const percent = totalBudget > 0 ? (spent / totalBudget) * 100 : 0;
                
                let statusClass = 'status-ok';
                let statusText = 'OK';
                
                if (percent >= 100) {
                    statusClass = 'status-danger';
                    statusText = 'EXCEDIDO';
                } else if (percent > 90) {
                    statusClass = 'status-danger';
                    statusText = 'CR√çTICO';
                } else if (percent > 70) {
                    statusClass = 'status-warning';
                    statusText = 'ATEN√á√ÉO';
                }
                
                const row = `
                    <tr>
                        <td><strong>${ministry.ministry}</strong></td>
                        <td>${formatCurrency(totalBudget)}</td>
                        <td style="color: ${percent >= 90 ? '#f44336' : 'inherit'}">${formatCurrency(spent)}</td>
                        <td style="color: ${available < 0 ? '#f44336' : 'inherit'}">${formatCurrency(available)}</td>
                        <td><strong>${percent.toFixed(1)}%</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
                rows.push(row);
            });
            
            // Substituir todo o conte√∫do de uma vez
            tbody.innerHTML = rows.join('');
        }

    function toggleIndicatorButton(isLoading, isManual = true) {
        const button = document.getElementById('btnUpdateIndicators');
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            if (isManual) {
                button.textContent = '‚è≥ Atualizando...';
            }
        } else {
            button.disabled = false;
            button.textContent = 'üîÑ Atualizar Agora';
        }
    }

    function setIndicatorStatus(message, status = 'info') {
        const statusEl = document.getElementById('indicatorsStatus');
        if (!statusEl) return;
        statusEl.textContent = message || '';
        statusEl.classList.remove('success', 'error', 'info');
        if (message) {
            statusEl.classList.add(status);
        }
    }

    async function updateIndicators(trigger = 'auto') {
        if (indicatorsLoading) return;
        indicatorsLoading = true;
        const isManual = trigger === 'manual';
        toggleIndicatorButton(true, isManual);
        setIndicatorStatus(isManual ? 'Atualizando indicadores...' : 'Sincronizando indicadores automaticamente...', 'info');

        try {
            const response = await fetch(CONFIG.INDICATORS_API, { cache: 'no-store' });
            if (!response.ok) {
                throw new Error(`API retornou ${response.status}`);
            }

            const data = await response.json();
            indicatorsData = data;
            displayIndicators();

            const updatedAt = data?.timestamp ? new Date(data.timestamp) : new Date();
            const label = isManual
                ? `Atualizado em ${updatedAt.toLocaleString('pt-BR')}`
                : `Atualizado automaticamente √†s ${updatedAt.toLocaleTimeString('pt-BR')}`;
            setIndicatorStatus(label, 'success');
        } catch (error) {
            console.error('Erro ao atualizar indicadores:', error);
            setIndicatorStatus('Falha ao atualizar indicadores.', 'error');
        } finally {
            indicatorsLoading = false;
            toggleIndicatorButton(false);
        }
    }

        // Expor fun√ß√£o para uso global (chamada via onclick)
        window.updateIndicators = updateIndicators;

        function displayIndicators() {
            if (!indicatorsData) return;
            
            const grid = document.getElementById('indicatorsGrid');
            const indicators = indicatorsData.indicators;
            
            // Atualizar D√≠vida/PIB no card principal
            if (indicators.gross_debt_pct_gdp) {
                const debtGDP = indicators.gross_debt_pct_gdp.value.toFixed(2);
                document.getElementById('debtGDP').textContent = debtGDP + '%';
                document.getElementById('debtStatus').textContent = 
                    debtGDP < 50 ? 'Em forte redu√ß√£o ‚úÖ' : 'Em redu√ß√£o üìâ';
            }
            
            // Cores para diferentes tipos de indicadores
            const colorMap = {
                'gdp': '#4caf50',
                'inflation': '#ff9800',
                'unemployment': '#f44336',
                'government': '#2196f3',
                'selic': '#9c27b0',
                'stock': '#00bcd4',
                'exchange': '#ff5722',
                'exports': '#8bc34a',
                'imports': '#e91e63',
                'debt': '#673ab7',
                'revenue': '#009688',
                'spending': '#ff9800',
                'default': '#607d8b'
            };
            
            // Fun√ß√£o para determinar cor baseada no nome do indicador
            function getIndicatorColor(key) {
                if (key.includes('gdp')) return colorMap.gdp;
                if (key.includes('inflation')) return colorMap.inflation;
                if (key.includes('unemployment')) return colorMap.unemployment;
                if (key.includes('approval')) return colorMap.government;
                if (key.includes('selic')) return colorMap.selic;
                if (key.includes('stock')) return colorMap.stock;
                if (key.includes('exchange')) return colorMap.exchange;
                if (key.includes('export')) return colorMap.exports;
                if (key.includes('import')) return colorMap.imports;
                if (key.includes('debt')) return colorMap.debt;
                if (key.includes('revenue')) return colorMap.revenue;
                if (key.includes('spending')) return colorMap.spending;
                return colorMap.default;
            }
            
            grid.innerHTML = '';
            
            // Exibir TODOS os indicadores retornados pela API
            Object.entries(indicators).forEach(([key, data]) => {
                if (!data || !data.label) return;
                
                const changePercent = data.changePercent || 0;
                const changeClass = changePercent >= 0 ? 'positive' : 'negative';
                const changeSymbol = changePercent >= 0 ? '‚Üë' : '‚Üì';
                const color = getIndicatorColor(key);
                
                // Formatar valor com unidade apropriada
                let displayValue = data.formatted || data.value.toFixed(2);
                if (data.unit === 'percentage') {
                    displayValue += '%';
                } else if (data.unit === 'currency_brl') {
                    displayValue = 'R$ ' + displayValue;
                } else if (data.unit === 'currency_usd') {
                    displayValue = 'US$ ' + displayValue;
                }
                
                const card = `
                    <div class="indicator-card" style="border-left-color: ${color}">
                        <div class="indicator-label">${data.label}</div>
                        <div class="indicator-value">${displayValue}</div>
                        <div class="indicator-change ${changeClass}">
                            ${changeSymbol} ${Math.abs(changePercent).toFixed(2)}%
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        function openSubmitProposal() {
            window.location.href = 'submit-proposal.html';
        }

        function openExtract() {
            window.location.href = 'extract.html';
        }

        function openAdminPanel() {
            window.location.href = 'admin.html';
        }

        function logout() {
            localStorage.removeItem('govUser');
            window.location.reload();
        }

          // Expor fun√ß√µes para uso global (chamadas via onclick)
          window.openSubmitProposal = openSubmitProposal;
          window.openExtract = openExtract;
          window.openAdminPanel = openAdminPanel;
          window.logout = logout;
          window.openLegalAssistant = openLegalAssistant;
          window.closeLegalAssistant = closeLegalAssistant;
          window.resetLegalAssistantForm = resetLegalAssistantForm;
          window.downloadLegalAssistantDocument = downloadLegalAssistantDocument;
          window.openLegalAssistantDocument = openLegalAssistantDocument;
          window.copyLegalAssistantHtml = copyLegalAssistantHtml;

        // ==== SISTEMA DE NOTIFICA√á√ïES ====
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            const isHidden = panel.style.display === 'none' || panel.style.display === '';
            panel.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                displayNotifications();
            }
        }

        function closeNotifications() {
            document.getElementById('notificationsPanel').style.display = 'none';
        }

        // Expor fun√ß√µes de notifica√ß√£o
        window.toggleNotifications = toggleNotifications;
        window.closeNotifications = closeNotifications;
        window.markAllNotificationsAsRead = markAllNotificationsAsRead;
        window.closeNotificationModal = closeNotificationModal;
        window.closeAdjustmentModal = closeAdjustmentModal;
        window.submitProposalAdjustment = submitProposalAdjustment;

        function formatTimeAgo(input) {
            if (!input) return 'Agora mesmo';

            let date;
            if (input instanceof Date) {
                date = input;
            } else if (input && typeof input.toDate === 'function') {
                date = input.toDate();
            } else if (typeof input === 'string' || typeof input === 'number') {
                date = new Date(input);
            } else {
                return 'Agora mesmo';
            }

            if (!date || isNaN(date.getTime())) return 'Agora mesmo';

            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Agora mesmo';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min atr√°s`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h atr√°s`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d atr√°s`;
            return date.toLocaleDateString('pt-BR');
        }

        // ==== SISTEMA DE ACOMPANHAMENTO DE PROPOSTAS ====
        function loadApprovedProposals() {
            if (proposalsData.length === 0) {
                return; // N√£o mostra a se√ß√£o se n√£o houver propostas
            }

            // Mostrar se√ß√£o
            document.getElementById('proposalsTracking').style.display = 'block';

            const listContainer = document.getElementById('proposalsList');
            
            // Filtrar propostas relevantes
            const relevantProposals = userData.role === 'Presidenta' || userData.role === 'Vice-Presidente'
                ? proposalsData // Pres/Vice veem todas
                : proposalsData.filter(p => p.requestorName === userData.name); // Ministros veem apenas suas

            if (relevantProposals.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">Nenhuma proposta aprovada ainda</p>';
                return;
            }

            listContainer.innerHTML = relevantProposals.map((proposal) => {
                const publicationStatus = proposal.publicationStatus || 'pending_approval';
                const statusText = {
                    'pending_approval': '‚è≥ Aguardando Publica√ß√£o',
                    'published': '‚úÖ Publicado no System',
                    'in_force': 'üéØ Em Vigor'
                };
                const statusClass = `status-${publicationStatus}`;

                const canMarkPublished = (userData.role !== 'Presidenta' && userData.role !== 'Vice-Presidente' && proposal.requestorName === userData.name) || 
                                       (userData.role === 'Presidenta' || userData.role === 'Vice-Presidente');

                return `
                    <div class="proposal-track-card">
                        <div class="proposal-track-header">
                            <div class="proposal-track-title">${proposal.documentType}: ${proposal.summary}</div>
                            <span class="status-badge-track ${statusClass}">${statusText[publicationStatus]}</span>
                        </div>
                        
                        <div class="proposal-track-info">
                            <div class="info-item">
                                <span class="info-label">Solicitante</span>
                                <span class="info-value">${proposal.requestorName}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Cargo</span>
                                <span class="info-value">${proposal.position}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Custo</span>
                                <span class="info-value">${formatCurrency(proposal.estimatedCost)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Aprovado em</span>
                                <span class="info-value">${formatDate(proposal.approvedAt)}</span>
                            </div>
                        </div>

                        ${proposal.systemDocumentLink ? `
                            <div style="margin-top: 1rem;">
                                <a href="${proposal.systemDocumentLink}" target="_blank" class="document-link">
                                    üîó Ver documento no System Oficial
                                </a>
                            </div>
                        ` : ''}

                        ${canMarkPublished && publicationStatus === 'pending_approval' ? `
                            <div class="proposal-track-actions">
                                <button class="btn-mark-published" onclick="window.markAsPublished('${proposal.id}')">
                                    ‚úÖ Marcar como Publicado
                                </button>
                            </div>
                        ` : ''}

                        ${canMarkPublished && publicationStatus === 'published' ? `
                            <div class="proposal-track-actions">
                                <button class="btn-mark-published" onclick="window.markAsInForce('${proposal.id}')" style="background: #1565c0;">
                                    üéØ Marcar como Em Vigor
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function markAsPublished(proposalId) {
            const link = prompt('Cole o link ou n√∫mero do documento publicado no System Oficial:');
            if (!link) return;

            try {
                await updateDoc(doc(db, 'proposals', proposalId), {
                    publicationStatus: 'published',
                    systemDocumentLink: link,
                    publishedAt: serverTimestamp()
                });

                alert('‚úÖ Proposta marcada como publicada!');
            } catch (error) {
                console.error('Erro ao atualizar proposta:', error);
                alert('‚ùå Erro ao atualizar proposta. Tente novamente.');
            }
        }

        async function markAsInForce(proposalId) {
            if (!confirm('Confirmar que o documento est√° oficialmente em vigor?')) return;

            try {
                await updateDoc(doc(db, 'proposals', proposalId), {
                    publicationStatus: 'in_force',
                    inForceAt: serverTimestamp()
                });

                alert('üéØ Proposta marcada como em vigor!');
            } catch (error) {
                console.error('Erro ao atualizar proposta:', error);
                alert('‚ùå Erro ao atualizar proposta. Tente novamente.');
            }
        }

        // Tornar fun√ß√µes globais
        window.markAsPublished = markAsPublished;
        window.markAsInForce = markAsInForce;

        // Fun√ß√£o para carregar avatar do Habbo via API
        async function loadHabboAvatar(habboName) {
            try {
                const response = await fetch(`https://www.habbo.com.br/api/public/users?name=${encodeURIComponent(habboName)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.figureString) {
                        // Construir URL da imagem do Habbo
                        const avatarUrl = `https://www.habbo.com.br/habbo-imaging/avatarimage?figure=${data.figureString}&size=m&direction=2&head_direction=3&gesture=sml`;
                        const avatarImg = document.getElementById('userHabboAvatar');
                        avatarImg.src = avatarUrl;
                        avatarImg.style.display = 'block';
                    }
                } else {
                    console.warn('Usu√°rio Habbo n√£o encontrado:', habboName);
                }
            } catch (error) {
                console.error('Erro ao buscar avatar do Habbo:', error);
            }
        }

        // Sistema de comunica√ß√£o com ChocoBot iframe
        const chocobotFrame = document.getElementById('chocobotFrame');
        const chocobotButtonClone = document.getElementById('chocobotButtonClone');
        
        // Bot√£o clone controla o iframe
        chocobotButtonClone.addEventListener('click', () => {
            // Habilitar iframe temporariamente
            chocobotFrame.style.pointerEvents = 'auto';
            
            // Enviar mensagem para o iframe abrir o chat
            try {
                chocobotFrame.contentWindow.postMessage({ type: 'toggleChat' }, '*');
            } catch (e) {
                console.error('Erro ao comunicar com iframe:', e);
            }
        });
        
        // Escutar mensagens do iframe
        window.addEventListener('message', (event) => {
            // Verificar origem (seguran√ßa)
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'chocobotOpen') {
                // Chat abriu, esconder bot√£o clone e permitir intera√ß√£o com iframe
                chocobotButtonClone.style.display = 'none';
                chocobotFrame.style.pointerEvents = 'auto';
            } else if (event.data.type === 'chocobotClose') {
                // Chat fechou, mostrar bot√£o clone e desabilitar intera√ß√£o com iframe
                chocobotButtonClone.style.display = 'flex';
                chocobotFrame.style.pointerEvents = 'none';
            }
        });
        
        // Deixar iframe inicialmente sem pointer-events
        chocobotFrame.style.pointerEvents = 'none';
    </script>
</body>
</html>
